<?xml version="1.0" encoding="windows-1251"?>
<Session xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">
  <Code>0</Code>
  <Title>Parsec</Title>
  <Note>Server=WAR05110009\SQLEXPRESS;
Integrated Security=SSPI; Persist Security Info=false;

Server=SCMA-SRV-BS25\PARSECDB;
uid=sa; pwd=parsec;
Server=SCMA-SRV-BY09\PARSECDB;
</Note>
  <DBConnection>
	Provider=SQLNCLI;
	DataBase=Parsec3;
	Server=LGSCMA;
	uid=sa; pwd=parsec;
	Connect Timeout=90;
</DBConnection>
  <ParamBegDelim>#?</ParamBegDelim>
  <ParamEndDelim>?#</ParamEndDelim>
  <Hash>eeb528fb4624092c109330428f88663c</Hash>
  <ImagePath />
  <ImageName />
  <Params />
  <Queries>
    <Query>
      <Code>0</Code>
      <Name>_System\COUNT records in all tables</Name>
      <DateCreate>2010-06-02T11:00:02.8954511+03:00</DateCreate>
      <DateLastModified>2010-06-01T23:00:00+03:00</DateLastModified>
      <Hidden>true</Hidden>
      <Author />
      <Note />
      <Text>DECLARE tables_cursor CURSOR
   FOR
   SELECT name FROM sysobjects WHERE type = 'U'
OPEN tables_cursor
DECLARE @tablename sysname
FETCH NEXT FROM tables_cursor INTO @tablename
	WHILE (@@FETCH_STATUS &lt;&gt; -1)
	BEGIN
	   /* A @@FETCH_STATUS of -2 means that the row has been deleted.
	   There is no need to test for this because this loop drops all
	   user-defined tables.   */
	   EXEC ('SELECT '''+@tablename+''',  COUNT(*) FROM ' + @tablename)
	   FETCH NEXT FROM tables_cursor INTO @tablename
	END

DEALLOCATE tables_cursor

</Text>
      <XSLT />
      <ImageName />
      <Params />
    </Query>
    <Query>
      <Code>0</Code>
      <Name>_System\Depart</Name>
      <DateCreate>2010-06-03T15:34:25.0180041+03:00</DateCreate>
      <DateLastModified>2010-08-30T23:00:00+03:00</DateLastModified>
      <Hidden>true</Hidden>
      <Author />
      <Note />
      <Text>SELECT 
	--ISNULL(CAST(DP.ID_DEP AS varchar(10))+'~', '')+CAST(DC.ID_DEP AS varchar(10)) AS aPath, 
	--DP.DeptName, 
	DC.* 
FROM 
	Depart AS DC 
	--	LEFT JOIN Depart AS DP ON DC.Parent_ID=DP.ID_DEP
ORDER BY 
	1</Text>
      <XSLT />
      <ImageName />
      <Params />
    </Query>
    <Query>
      <Code>0</Code>
      <Name>_System\Dep-Dep</Name>
      <DateCreate>2010-08-31T09:22:12.266373+03:00</DateCreate>
      <DateLastModified>2010-08-30T23:00:00+03:00</DateLastModified>
      <Hidden>true</Hidden>
      <Author />
      <Note />
      <Text>
SELECT D1.ID_DEP AS DD 
	FROM Depart AS D1 
	--WHERE D1.ID_DEP = 47
UNION
SELECT D2.ID_DEP AS DD 
	FROM Depart AS D1 
		INNER JOIN Depart AS D2 ON D1.ID_DEP=D2.Parent_ID
	--WHERE D1.ID_DEP = 47
UNION
SELECT D3.ID_DEP AS DD 
	FROM Depart AS D1 
		INNER JOIN Depart AS D2 ON D1.ID_DEP=D2.Parent_ID
		INNER JOIN Depart AS D3 ON D2.ID_DEP=D3.Parent_ID
	--WHERE D1.ID_DEP = 47
UNION
SELECT D4.ID_DEP AS DD 
	FROM Depart AS D1 
		INNER JOIN Depart AS D2 ON D1.ID_DEP=D2.Parent_ID
		INNER JOIN Depart AS D3 ON D2.ID_DEP=D3.Parent_ID
		INNER JOIN Depart AS D4 ON D3.ID_DEP=D4.Parent_ID
	--WHERE D1.ID_DEP = 47
UNION
SELECT D5.ID_DEP AS DD 
	FROM Depart AS D1 
		INNER JOIN Depart AS D2 ON D1.ID_DEP=D2.Parent_ID
		INNER JOIN Depart AS D3 ON D2.ID_DEP=D3.Parent_ID
		INNER JOIN Depart AS D4 ON D3.ID_DEP=D4.Parent_ID
		INNER JOIN Depart AS D5 ON D4.ID_DEP=D5.Parent_ID
	--WHERE D1.ID_DEP = 47
SELECT D6.ID_DEP AS DD 
	FROM Depart AS D1 
		INNER JOIN Depart AS D2 ON D1.ID_DEP=D2.Parent_ID
		INNER JOIN Depart AS D3 ON D2.ID_DEP=D3.Parent_ID
		INNER JOIN Depart AS D4 ON D3.ID_DEP=D4.Parent_ID
		INNER JOIN Depart AS D5 ON D4.ID_DEP=D5.Parent_ID
		INNER JOIN Depart AS D6 ON D5.ID_DEP=D6.Parent_ID
	--WHERE D1.ID_DEP = 47
SELECT D7.ID_DEP AS DD 
	FROM Depart AS D1 
		INNER JOIN Depart AS D2 ON D1.ID_DEP=D2.Parent_ID
		INNER JOIN Depart AS D3 ON D2.ID_DEP=D3.Parent_ID
		INNER JOIN Depart AS D4 ON D3.ID_DEP=D4.Parent_ID
		INNER JOIN Depart AS D5 ON D4.ID_DEP=D5.Parent_ID
		INNER JOIN Depart AS D6 ON D5.ID_DEP=D6.Parent_ID
		INNER JOIN Depart AS D7 ON D6.ID_DEP=D7.Parent_ID
	--WHERE D1.ID_DEP = 47




/*
SELECT 
	ID_DEP)))))) AS DD
	
	,D7.ID_DEP 
	,D6.ID_DEP
	,D5.ID_DEP
	,D4.ID_DEP
	,D3.ID_DEP
	,D2.ID_DEP 
	,D1.ID_DEP
	
FROM Depart AS D1 
	LEFT JOIN Depart AS D2 ON D1.ID_DEP=D2.Parent_ID
	LEFT JOIN Depart AS D3 ON D2.ID_DEP=D3.Parent_ID
	LEFT JOIN Depart AS D4 ON D3.ID_DEP=D4.Parent_ID
	LEFT JOIN Depart AS D5 ON D4.ID_DEP=D5.Parent_ID
	LEFT JOIN Depart AS D6 ON D5.ID_DEP=D6.Parent_ID
	LEFT JOIN Depart AS D7 ON D6.ID_DEP=D7.Parent_ID
WHERE
	D1.ID_DEP = 47
	
ORDER BY 1
*/</Text>
      <XSLT />
      <ImageName />
      <Params />
    </Query>
    <Query>
      <Code>0</Code>
      <Name>_System\Doors</Name>
      <DateCreate>2010-06-03T08:53:31.2487447+03:00</DateCreate>
      <DateLastModified>2010-06-02T23:00:00+03:00</DateLastModified>
      <Hidden>true</Hidden>
      <Author />
      <Note />
      <Text>SELECT [ID_DOOR]
      ,[ADDRESS_ID]
      ,[AreaName]
      ,[DoorDescriptor]
      ,[ContrEnabled]
      ,[LockTime]
      ,[DoorOpenTime]
      ,[ExitTime]
      ,[AlarmTime]
      ,[ReleDelay]
      ,[ReleTime]
      ,[ReleTypeLatch]
      ,[HasSecondReader]
      ,[HasLockSwitch]
      ,[HasRTESwitch]
      ,[SoundIfDoorOpen]
      ,[HasDoorContact]
      ,[DoorAlarmNoArmed]
      ,[ResetLockByDC]
      ,[CheckAUXInput]
      ,[ReleOnAlarm]
      ,[ReleOnDoorForced]
      ,[ReleOnNoEntry]
      ,[ReleOnEntry]
      ,[ReleOnExit]
      ,[ReleOnLineWork]
      ,[OnCardLed]
      ,[OnCardBeep]
      ,[AuxHas4State]
      ,[DCHas4State]
      ,[PowerLED]
      ,[RealAccess]
      ,[GraphPlan]
      ,[OperInstruction]
      ,[AutoClose]
      ,[SoundFileName]
      ,[GraphPlanLow]
      ,[GraphPlanHigh]
      ,[Turnstile]
      ,[Perimeter]
      ,[TimeInSec]
      ,[APB_Enabled]
      ,[ReleExtraType]
      ,[HasExternalReader]
      ,[APBinOffLine]
      ,[ContrType]
      ,[KSound]
      ,[KLight]
      ,[KBlocking]
      ,[KLightTime]
      ,[KOffTime]
      ,[KConfig]
      ,[CheckAUXInput2]
      ,[AuxHas4State2]
      ,[AlarmSensor24h]
      ,[RegistrationMode]
      ,[HasDRTESwitch]
      ,[HasCardRead]
      ,[CardBox]
      ,[Deleted]
      ,[LastUpdate]
      ,[PhoneNumber]
      ,[CardRecieverMode]
  FROM [ParsecDB].[dbo].[Doors]
  </Text>
      <XSLT />
      <ImageName />
      <Params />
    </Query>
    <Query>
      <Code>0</Code>
      <Name>_System\Personel</Name>
      <DateCreate>2010-06-02T12:56:01.7525553+03:00</DateCreate>
      <DateLastModified>2010-08-29T23:00:00+03:00</DateLastModified>
      <Hidden>true</Hidden>
      <Author />
      <Note />
      <Text>SELECT * 
FROM Personel</Text>
      <XSLT />
      <ImageName />
      <Params />
    </Query>
    <Query>
      <Code>0</Code>
      <Name>_System\Tables</Name>
      <DateCreate>2010-06-02T10:43:45.4476455+03:00</DateCreate>
      <DateLastModified>2010-06-01T23:00:00+03:00</DateLastModified>
      <Hidden>true</Hidden>
      <Author />
      <Note />
      <Text>SELECT * 
FROM dbo.sysobjects
WHERE
	xtype = 'U'
ORDER BY
	name
	</Text>
      <XSLT />
      <ImageName />
      <Params />
    </Query>
    <Query>
      <Code>0</Code>
      <Name>_System\TransDesc</Name>
      <DateCreate>2010-06-04T11:06:13.2969542+03:00</DateCreate>
      <DateLastModified>2010-06-03T23:00:00+03:00</DateLastModified>
      <Hidden>true</Hidden>
      <Author />
      <Note />
      <Text>SELECT * FROM TransDesc</Text>
      <XSLT />
      <ImageName />
      <Params />
    </Query>
    <Query>
      <Code>0</Code>
      <Name>_System\TransLog</Name>
      <DateCreate>2010-06-02T12:46:20.8646032+03:00</DateCreate>
      <DateLastModified>2010-06-07T23:00:00+03:00</DateLastModified>
      <Hidden>true</Hidden>
      <Author />
      <Note />
      <Text>SET dateformat dmy

SELECT 
	[ID_TRAN]
	,CONVERT(varchar(50), [TranDateTime], 121) AS TranDateTime
	,[TranCode]
	,[IsAlarm]
	,[TranDesc]
	,[TranArea]
	,[TranUser]
	,[TranCtrlID]
	,[TranUserID]
	,[TranOperID]
	,[Param1]
	,[Param2]
	,[OperDateTime]
	,[Arch_ID]
FROM 
	TransLog
WHERE
	TranDateTime &gt;= #?pDateFrom?#
	AND TranDateTime &lt; #?pToDate?#
#?pFltUser?#
#?pFltLock?#
--	AND TranCode IN (32,33,34)
</Text>
      <XSLT />
      <ImageName />
      <Params>
        <Param>
          <Number>2</Number>
          <Title>Çà ïåðèîä ñ (&gt;=)</Title>
          <Name>pDateFrom</Name>
          <Type>Date</Type>
          <Inset>false</Inset>
          <CurrentValue>08.06.2010</CurrentValue>
          <DefaultValue />
          <SelectValue />
        </Param>
        <Param>
          <Number>4</Number>
          <Title>äî (&lt;)</Title>
          <Name>pToDate</Name>
          <Type>Date</Type>
          <Inset>false</Inset>
          <CurrentValue>09.06.2010</CurrentValue>
          <DefaultValue />
          <SelectValue />
        </Param>
        <Param>
          <Number>6</Number>
          <Title>User</Title>
          <Name>pFltUser</Name>
          <Type>StrSelectList</Type>
          <Inset>true</Inset>
          <CurrentValue>:ÂÑÅ</CurrentValue>
          <DefaultValue />
          <SelectValue>~ÂÑÅ
;
SET dateformat dmy
SELECT DISTINCT
	'AND TranUserID = '+CAST(TranUserID AS varchar(8)),
	TranUser
FROM
	TransLog
WHERE
	TranDateTime &gt;= #?pDateFrom?#
	AND TranDateTime &lt; #?pToDate?#
ORDER BY 2
</SelectValue>
        </Param>
        <Param>
          <Number>8</Number>
          <Title>Lock</Title>
          <Name>pFltLock</Name>
          <Type>StrSelectList</Type>
          <Inset>true</Inset>
          <CurrentValue />
          <DefaultValue />
          <SelectValue>~ÂÑÅ
;
SET dateformat dmy
SELECT DISTINCT
	'AND TranCtrlID = '+CAST(TranCtrlID AS varchar(25)),
	TranArea
FROM
	TransLog
WHERE
	TranDateTime &gt;= #?pDateFrom?#
	AND TranDateTime &lt; #?pToDate?#
ORDER BY 2
</SelectValue>
        </Param>
      </Params>
    </Query>
    <Query>
      <Code>0</Code>
      <Name>Input_Output</Name>
      <DateCreate>2010-06-02T12:46:20.8646032+03:00</DateCreate>
      <DateLastModified>2015-08-07T00:00:00+03:00</DateLastModified>
      <Hidden>true</Hidden>
      <Author>M.Tor</Author>
      <Note />
      <Text>
SET dateformat dmy

DECLARE @BWDay AS varchar(10), @FWDay AS varchar(10)
DECLARE @CriticalPeriodIn int, @CriticalPeriodOut int
DECLARE @WDRangeSec int

SET @BWDay = ' 09:00:00' -- íà÷àëî ðàáî÷åãî äíÿ !!! ïðîáåë â íà÷àëå ÎÁßÇÀÒÅËÅÍ
SET @FWDay = ' 18:00:00' -- îêîí÷àíèå ðàáî÷åãî äíÿ !!! ïðîáåë â íà÷àëå ÎÁßÇÀÒÅËÅÍ
SET @CriticalPeriodIn = 3600 -- èíòåðâàë âðåìåíè (ñåê.) ñ÷èòàþùèéñÿ îïîçäàíèåì ïðèõîäà
SET @CriticalPeriodOut = 3600 -- èíòåðâàë âðåìåíè (ñåê.) ñ÷èòàþùèéñÿ ðàííèì óõîäîì
SET @WDRangeSec = 9*3600 -- ïðîäîëæèòåëüíîñòü ðàáî÷åãî äíÿ (ñåê.)

DECLARE  @TInOut table 
	(aDate varchar(20), aTimeIn datetime, aTimeOut datetime, aUserID int, aUser varchar(255))
DECLARE  @TInOutWDE table 
	(aDate varchar(20), aTimeIn datetime, aTimeOut datetime, aUserID int, aUser varchar(255), aWDay int, aDelayIn int, aEarlyOut int)
DECLARE @TSumCountDE table
	(aUserID int, aUser varchar(255)
	,aSumWDay int, aCountWDay int
	,aSumDelayIn int, aCountDelayIn int
	,aSumEarlyOut int, aCountEarlyOut int)
	
INSERT @TInOut
SELECT 
	CONVERT(varchar(20), TranDateTime, 104)
	,MIN(TranDateTime)
	,MAX(TranDateTime)
	,TranUserID
	,TranUser
FROM 
	TransLog
WHERE
	TranDateTime &gt;= #?pDateFrom?#
	AND TranDateTime &lt; #?pToDate?#
	#?pFltUser?#
GROUP BY 
	CONVERT(varchar(20), TranDateTime, 104),TranUserID,TranUser

INSERT @TInOutWDE
SELECT 
	aDate
	,aTimeIn
	,aTimeOut
	,aUserID, aUser
	,DATEDIFF(s, aTimeIn, aTimeOut) AS aWDay
	,CASE 
		WHEN DATEDIFF(s, CAST(aDate+@BWDay AS datetime) , aTimeIn) &gt; 0 AND DATEDIFF(s, CAST(aDate+@BWDay AS datetime) , aTimeIn) &lt; @CriticalPeriodIn
			THEN DATEDIFF(s, CAST(aDate+@BWDay AS datetime) , aTimeIn)
		ELSE null	
	  END AS aDelayIn
	,CASE 
		WHEN DATEDIFF(s, aTimeOut, CAST(aDate+@FWDay AS datetime)) &gt; 0 AND DATEDIFF(s, aTimeOut, CAST(aDate+@FWDay AS datetime)) &lt; @CriticalPeriodOut
			THEN DATEDIFF(s, aTimeOut, CAST(aDate+@FWDay AS datetime))
		ELSE null	
	  END AS aEarlyOut
FROM
	@TInOut

	
SELECT 
	aUserID, aUser
	,aDate
	,CONVERT(varchar(50), aTimeIn, 120)
	,CONVERT(varchar(50), aTimeOut, 120)
	,aWDay
	,aDelayIn
	,aEarlyOut
FROM
	@TInOutWDE


INSERT @TSumCountDE	
SELECT 
	aUserID, aUser
	,ISNULL(SUM(aWDay), 0)
	,ISNULL(COUNT(aWDay), 0)
	,ISNULL(SUM(aDelayIn), 0)
	,ISNULL(COUNT(aDelayIn), 0)
	,ISNULL(SUM(aEarlyOut), 0)
	,ISNULL(COUNT(aEarlyOut), 0)
FROM
	@TInOutWDE
GROUP BY aUserID, aUser

SELECT
	aUserID, aUser
	-- Êîë-âî ïðèõîäîâ íà ðàáîòó
	,aCountWDay 
	-- Ñóììàðíîå ðàá. âðåìÿ çà ìåñÿö
	,CAST(CAST(aSumWDay/3600 as int) as varchar(8))+' ÷., '+CAST(CAST((aSumWDay%3600)/60 as int) as varchar(8))+' ìèí.' AS aWHourMinute
	-- Îòêëîíåíèå îò íîðìàòèâà
	,CASE WHEN (aSumWDay-@WDRangeSec*aCountWDay) &gt; 0 THEN '' ELSE '-' END	
		+ CAST(CAST(ABS(aSumWDay-@WDRangeSec*aCountWDay)/3600 as int) as varchar(8))+' ÷., '+CAST(CAST((ABS(aSumWDay-@WDRangeSec*aCountWDay)%3600)/60 as int) as varchar(8))+' ìèí.' AS aWÂDifHourMinute 
	-- Ñðåäíÿÿ ïðîäîëæèòåëüíîñòü ðàá.äíÿ
	,CAST(CAST(aSumWDay/aCountWDay/3600 as int) as varchar(8))+' ÷., '+CAST(CAST(((aSumWDay/aCountWDay)%3600)/60 as int) as varchar(8))+' ìèí.' AS aWAvgHourMinute
	-- Íåñâîåâðåìåííûé ïðèõîä êîë-âî
	,aCountDelayIn
	-- Íåñâîåâðåìåííûé ïðèõîä ñóìì.âðåìÿ
	,CAST(CAST(aSumDelayIn/3600 as int) as varchar(8))+' ÷., '+CAST(CAST((aSumDelayIn%3600)/60 as int) as varchar(8))+' ìèí.' AS aDelayHourMinute
	-- Íåñâîåâðåìåííûé óõîä êîë-âî
	,aCountEarlyOut
	-- Íåñâîåâðåìåííûé óõîä ñóìì.âðåìÿ
	,CAST(CAST(aSumEarlyOut/3600 as int) as varchar(8))+' ÷., '+CAST(CAST((aSumEarlyOut%3600)/60 as int) as varchar(8))+' ìèí.' AS aEarlyHourMinute
FROM 
	@TSumCountDE</Text>
      <XSLT />
      <ImageName />
      <Params>
        <Param>
          <Number>2</Number>
          <Title>Çà ïåðèîä ñ (&gt;=)</Title>
          <Name>pDateFrom</Name>
          <Type>Date</Type>
          <Inset>false</Inset>
          <CurrentValue>01.01.2009</CurrentValue>
          <DefaultValue />
          <SelectValue />
        </Param>
        <Param>
          <Number>4</Number>
          <Title>äî (&lt;)</Title>
          <Name>pToDate</Name>
          <Type>Date</Type>
          <Inset>false</Inset>
          <CurrentValue>31.12.2009</CurrentValue>
          <DefaultValue />
          <SelectValue />
        </Param>
        <Param>
          <Number>6</Number>
          <Title>User</Title>
          <Name>pFltUser</Name>
          <Type>StrSelectList</Type>
          <Inset>true</Inset>
          <CurrentValue />
          <DefaultValue />
          <SelectValue>~ÂÑÅ
;
SET dateformat dmy
SELECT DISTINCT
	'AND TranUser LIKE '''+TranUser+'''',
	TranUser
FROM
	TransLog
WHERE
	TranDateTime &gt;= #?pDateFrom?#
	AND TranDateTime &lt; #?pToDate?#
</SelectValue>
        </Param>
      </Params>
    </Query>
    <Query>
      <Code>0</Code>
      <Name>Test\Domain_member and Person</Name>
      <DateCreate>2015-08-25T15:20:06.8154296+03:00</DateCreate>
      <DateLastModified>2015-09-08T00:00:00+03:00</DateLastModified>
      <Hidden>false</Hidden>
      <Author />
      <Note />
      <Text>SELECT 
* 
FROM 
[Parsec3].dbo.[Domain_Membership] as DM
INNER JOIN [Parsec3].dbo.[IDENTIFIER] as ID ON ID.CODE = DM.CODE AND ID.PIN = DM.PIN
INNER JOIN [Parsec3].dbo.[Person] as PP ON PP.Pers_ID = ID.PERS_ID </Text>
      <XSLT />
      <ImageName />
      <Params />
    </Query>
    <Query>
      <Code>0</Code>
      <Name>Test\Íîâûé çàïðîñ 19</Name>
      <DateCreate>2015-08-11T16:50:06.6035157+03:00</DateCreate>
      <DateLastModified>2015-09-08T00:00:00+03:00</DateLastModified>
      <Hidden>false</Hidden>
      <Author />
      <Note />
      <Text>SET DATEFORMAT dmy

DECLARE @dtFrom datetime
DECLARE @dtTo datetime
--SET @dtFrom = #pDateFrom?#
--SET @dtTo = #pDateTo?#
SET @dtFrom = #?pDateFrom?#
SET @dtTo = #?pDateTo?#

DECLARE @TINOUT TABLE(
					aID int, 
					aID2 uniqueidentifier, 
					aMask int, 
					aTranTypeID int, 
					aTranDescription varchar(255), 
					aUsrID uniqueidentifier, 
					aPerson varchar(255), 
					aTranDate datetime, 
					aTranDateStr varchar(255), 
					aCompID uniqueidentifier, 
					aComp1 varchar(255), aComp2 varchar(255))
INSERT INTO @TINOUT						
SELECT
PTTL.rid as aID, 
PTTL.TRAN_ID as aID2, 
PTT.TRANCLASS_MASK as aMask, 
PTTL.TRANTYPE_ID as aTranTypeID, 
PTD.TRANTYPE_DESC as aTranDescription, 
PTTL.USR_ID as aUsrID, 
PP.LAST_NAME as aPerson, 
DATEADD(hour, 3, PTTL.TRAN_DATE) as aTranDate, 
CONVERT(varchar(10), DATEADD(hour, 3, PTTL.TRAN_DATE), 104) + ' ' + CAST(DATEPART(hour, DATEADD(hour, 3, PTTL.TRAN_DATE)) as varchar(2)) + ':' 
				+ CASE 
					WHEN LEN(CAST(DATEPART(minute, DATEADD(hour, 3, PTTL.TRAN_DATE)) as varchar(2))) = 1 
						THEN '0' + CAST(DATEPART(minute, DATEADD(hour, 3, PTTL.TRAN_DATE)) as varchar(2))
					ELSE CAST(DATEPART(minute, DATEADD(hour, 3, PTTL.TRAN_DATE)) as varchar(2))
					END 
				+ ':' 
				+ CAST(DATEPART(ss, DATEADD(hour, 3, PTTL.TRAN_DATE)) as varchar(2)), 
--PTER.TERRA_NAME as aComp1, 
PTTL.COMP_ID as aCompID, 
COMP.COMP_NAME as aComp1, 
CC.FULLNAME as aComp2
FROM 
	[Parsec3Trans].dbo.[TransLog] AS PTTL
		INNER JOIN [Parsec3].[dbo].[TRANTYPES_DESC] AS PTD 
			ON PTTL.TRANTYPE_ID = PTD.TRANTYPE_ID
			AND PTD.LOCALE = 'RU'
		INNER JOIN [Parsec3].[dbo].[TRANTYPES] AS PTT
			ON PTTL.TRANTYPE_ID = PTT.TRANTYPE_ID
		/*LEFT JOIN [Parsec3].[dbo].[TERRITORY] AS PTER
			ON PTTL.COMP_ID = PTER.ITEM_ID*/
		LEFT JOIN [Parsec3].[dbo].[COMPONENT] as COMP
			ON PTTL.COMP_ID = COMP.COMP_ID
		LEFT JOIN [Parsec3].[dbo].[PERSON] as PP
			ON PP.PERS_ID = PTTL.USR_ID
		LEFT JOIN [Parsec3].dbo.[DOMAIN_MEMBERSHIP] as CC
			ON CC.M_ID = PTTL.COMP_ID

WHERE
	DATEADD(hour, 3, PTTL.TRAN_DATE) &gt;= @dtFrom
	AND DATEADD(hour, 3, PTTL.TRAN_DATE) &lt; DATEADD(day, 1, @dtTo)
	--AND PTTL.TRANTYPE_ID IN(590144, 590145)					

	SELECT * FROM @TINOUT ORDER BY 1 DESC
	
	--SELECT * FROM [Parsec3].[dbo].[TRANTYPES_DESC] WHERE LOCALE = 'RU' ORDER BY TRANTYPE_ID
	
	
/*	SET DATEFORMAT dmy

SELECT --TOP 10
	RRR.*,
	-- Ð´Ð°Ð»ÐµÐµ Ð½Ð°ÑÐ¾Ð´Ð¸Ð¼ Ð±Ð»Ð¸Ð¶Ð°Ð¹ÑÑÑ Ð·Ð°Ð¿Ð¸ÑÑÑ Ð² TRANSLOG Ñ ÑÐºÐ°Ð·Ð°Ð½ÑÐ¼ COMP_ID
	-- Ð¸ Ð±ÐµÑÐµÐ¼ USR_ID
	(SELECT TOP 1 [USR_ID]
	 FROM [Parsec3Trans].[dbo].[TRANSLOG]
	 WHERE [TRAN_DATE] &lt; RRR.[REVISION_DATE]
	   AND [COMP_ID] = '09A29015-5E26-4C2F-B961-F36FC468BEDB'
	 ORDER BY [TRAN_DATE] DESC
	) AS TTT_ID

  FROM 
	[Parsec3].[dbo].[VISITOR_REQUEST] AS RRR

WHERE 
	RRR.[REQUEST_DATE] &gt; '12.08.2015'
ORDER BY 
	RRR.[REQUEST_DATE] --DESC*/
	

--- Ð² Ð¿Ð¾Ð»ÑÑÐ¸Ð²ÑÐµÐ¹ÑÑ Ð²ÑÐ±Ð¾ÑÐºÐµ Guid_Detalis - Ð­Ð¢Ð ÐÐÐÐÐ  Ð¡ÐÐÐÐÐÐÐÐ ÐÐÐ¯ÐÐÐ,
--- Ð TRAN_ID - Ð­Ð¢Ð ÐÐÐ¨Ð Ð¡ÐÐÐ«Ð¢ÐÐ "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¾Ð±ÑÐµÐºÑÐ° Ð·Ð°ÑÐ²ÐºÐ° Ð¿Ð¾ÑÐµÑÐ¸ÑÐµÐ»Ñ" 
---  ÐÐ TRANSLOG
</Text>
      <XSLT />
      <ImageName />
      <Params>
        <Param>
          <Number>1</Number>
          <Title>Äàòà ñ:</Title>
          <Name>pDateFrom</Name>
          <Type>Date</Type>
          <Inset>false</Inset>
          <CurrentValue>21.08.2015</CurrentValue>
          <DefaultValue />
          <SelectValue />
        </Param>
        <Param>
          <Number>2</Number>
          <Title>ïî</Title>
          <Name>pDateTo</Name>
          <Type>Date</Type>
          <Inset>false</Inset>
          <CurrentValue>21.08.2015</CurrentValue>
          <DefaultValue />
          <SelectValue />
        </Param>
      </Params>
    </Query>
    <Query>
      <Code>0</Code>
      <Name>Test\Íîâûé çàïðîñ 20</Name>
      <DateCreate>2015-08-13T14:40:27.0898437+03:00</DateCreate>
      <DateLastModified>2015-09-08T00:00:00+03:00</DateLastModified>
      <Hidden>false</Hidden>
      <Author />
      <Note />
      <Text>--use [parsec3trans]
--go



---ÐÐ·Ð²ÐµÑÑÐ½Ð¾, ÑÑÐ¾ ÑÐ¾Ð±ÑÑÐ¸Ñ (ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ 394572, Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð·Ð°ÑÐ²ÐºÐ¸ 394573)
-- TRANSLOG Ð²ÑÐ¶ÑÑÑÑ  Ñ GUID_DATE 
--- logic_type = 12  - workstation
---            = 13  - operator
---				= 14 - id Ð·Ð°ÑÐ²ÐºÐ¸

-- ÑÐ°ÑÑÐ¸ÑÐµÐ½Ð¸Ðµ Ð¿ÑÐ°Ð²
-- logic_type = 12 - workstation
-- logic_type = 13 - Ð¾Ð¿ÐµÑÐ°ÑÐ¾Ñ

-- Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð¸Ð´ÐµÐ½ÑÐ¸ÑÐ¸ÐºÐ°ÑÐ¾ÑÐ°



SET dateformat dmy
SELECT     
tl.rid, tl.TRAN_ID, tl.COMP_ID, tl.USR_ID, 
DATEADD(hour, 3, tl.TRAN_DATE), 
CONVERT(varchar(10), DATEADD(hour, 3, tl.TRAN_DATE), 104) + ' ' + CAST(DATEPART(hour, DATEADD(hour, 3, tl.TRAN_DATE)) as varchar(2)) + ':' 
				+ CASE 
					WHEN LEN(CAST(DATEPART(minute, DATEADD(hour, 3, tl.TRAN_DATE)) as varchar(2))) = 1 
						THEN '0' + CAST(DATEPART(minute, DATEADD(hour, 3, tl.TRAN_DATE)) as varchar(2))
					ELSE CAST(DATEPART(minute, DATEADD(hour, 3, tl.TRAN_DATE)) as varchar(2))
					END 
				+ ':' 
				+ CAST(DATEPART(ss, DATEADD(hour, 3, tl.TRAN_DATE)) as varchar(2)), 
tl.TRANTYPE_ID, 
 --data1.*
data1.PDATA AS Guid_Workstation, 
data2.PDATA AS Guid_Details, 
data3.PDATA AS Guid_Operator, 
--data4.PDATA as aGuid4, 
--data5.PDATA as aGuid5, 
--data6.PDATA as aGuid6--,
--DM.FULLNAME as aOperatorName, 
--CM.COMP_NAME as aCompName
--DM.LAST_NAME as aUnknownField
IC.*
FROM         [parsec3Trans].dbo.TRANSLOG AS tl --WITH (NOLOCK) 
					  LEFT JOIN
                      [parsec3Trans].dbo.GUID_DATA AS data1 
					  --WITH (NOLOCK) 
					  ON tl.rid = data1.rid AND data1.logic_type = 12 
					  LEFT JOIN
                      [parsec3Trans].dbo.GUID_DATA AS data2 
					  --WITH (NOLOCK) 
					  ON tl.rid = data2.rid AND data2.logic_type = 14 
					  LEFT JOIN
                      [parsec3Trans].dbo.GUID_DATA AS data3
					  --WITH (NOLOCK) 
					  ON tl.rid = data3.rid AND data3.logic_type = 13
					  
					 /* LEFT JOIN 
					  [parsec3Trans].dbo.GUID_DATA AS data4
					  on data4.rid = tl.rid AND data4.logic_type = 5
					  LEFT JOIN 
					  [parsec3Trans].dbo.GUID_DATA AS data5
					  on data5.rid = tl.rid AND data5.logic_type = 7
					  LEFT JOIN 
					  [parsec3Trans].dbo.GUID_DATA AS data6
					  on data6.rid = tl.rid AND data6.logic_type = 8*/
					  
					  
					  --LEFT JOIN
                      --[parsec3Trans].dbo.DWORD_DATA AS idata1
					  --WITH (NOLOCK) 
					  --ON tl.rid = idata1.rid --AND data1.logic_type = 12 
					  
					--  LEFT JOIN [parsec3].dbo.[DOMAIN_MEMBERSHIP] as DM ON DM.M_ID = data3.PDATA
					 --LEFT JOIN [parsec3].dbo.[PERSON] as DM ON DM.PERS_ID = data2.PDATA
					--LEFT JOIN [parsec3].dbo.[COMPONENT] as CM ON CM.COMP_ID = data2.PDATA
					LEFT JOIN [parsec3].dbo.[IDENTIFIER] as IC ON IC.[IDENTIFIER_ID] = data2.PDATA
where 
--data2.PDATA = '37d667b0-8857-46ed-9c09-71df39876133'
tran_id in('f7ec5ccf-5be2-4b90-ac9e-d69b87ac3bf4')--, 'cd3e575f-a0ec-4604-bae5-f82a34af59bd')
ORDER BY 5 desc</Text>
      <XSLT />
      <ImageName />
      <Params />
    </Query>
    <Query>
      <Code>0</Code>
      <Name>Test\Íîâûé çàïðîñ 21</Name>
      <DateCreate>2015-08-14T14:46:07.4853515+03:00</DateCreate>
      <DateLastModified>2015-09-08T00:00:00+03:00</DateLastModified>
      <Hidden>false</Hidden>
      <Author />
      <Note />
      <Text>set dateformat dmy

declare @rdate datetime
declare @zdate datetime

SET @rdate = (SELECT REVISION_DATE 
				FROM [Parsec3].[dbo].[VISITOR_REQUEST] 
				WHERE [REQUEST_ID] = 'af8c00ba-6b2f-499d-b3b0-e037e5fd95fa')
				
SET @zdate = (SELECT REQUEST_DATE 
				FROM [Parsec3].[dbo].[VISITOR_REQUEST] 
				WHERE [REQUEST_ID] = 'af8c00ba-6b2f-499d-b3b0-e037e5fd95fa')				

SELECT * FROM [Parsec3Trans].[dbo].[TRANSLOG]
	 WHERE DATEADD(hour, 3, [TRAN_DATE]) &lt; DATEADD(hour, 3, @rdate)
		AND DATEADD(hour, 3, [TRAN_DATE]) &gt; DATEADD(hour, 3, @zdate)
	   AND [COMP_ID] = '80015421-ec02-49bc-b41c-f0ceaf798e3c'  
	   
SELECT TOP 1 [USR_ID]
	 FROM [Parsec3Trans].[dbo].[TRANSLOG]
	 WHERE DATEADD(hour, 3, [TRAN_DATE]) &lt; DATEADD(hour, 3, @rdate)
		AND DATEADD(hour, 3, [TRAN_DATE]) &gt; DATEADD(hour, 3, @zdate)
	   AND [COMP_ID] = '80015421-ec02-49bc-b41c-f0ceaf798e3c'  
	 ORDER BY [TRAN_DATE] DESC
	</Text>
      <XSLT />
      <ImageName />
      <Params />
    </Query>
    <Query>
      <Code>0</Code>
      <Name>Test\Òåñòîâàÿ âåðñèÿ</Name>
      <DateCreate>2015-08-28T14:08:59.3720703+03:00</DateCreate>
      <DateLastModified>2015-09-08T00:00:00+03:00</DateLastModified>
      <Hidden>false</Hidden>
      <Author />
      <Note />
      <Text>

DECLARE @pos int -- Ð¿Ð¾Ð·Ð¸ÑÐ¸Ñ ÑÐ°Ð·Ð´ÐµÐ»Ð¸ÑÐµÐ»Ñ
DECLARE @str varchar(255) -- Ð¸ÑÑÐ¾Ð´Ð½Ð°Ñ ÑÑÑÐ¾ÐºÐ° Ñ ÑÐ°Ð·Ð´ÐµÐ»Ð¸ÑÐµÐ»ÑÐ¼Ð¸
DECLARE @strForLike varchar(255) -- Ð¿ÑÐ¾Ð¼ÐµÐ¶ÑÑÐ¾ÑÐ½Ð°Ñ ÑÑÑÐ¾ÐºÐ° Ð´Ð»Ñ ÑÑÐ°Ð²Ð½ÐµÐ½Ð¸Ñ
DECLARE @LikeStr varchar(255) -- Ð²ÑÑÐ¾Ð´Ð½Ð°Ñ ÑÑÑÐ¾ÐºÐ° Ð´Ð»Ñ ÑÑÐ°Ð²Ð½ÐµÐ½Ð¸Ñ
DECLARE @result varchar(255)

SET @str = '#pStr?#'
SET @LikeStr = ''

WHILE (LEN(@str) &gt; 0)
BEGIN
	SET @pos = CHARINDEX(';', @str, 0)
	IF (@pos &gt; 0)
		BEGIN
			SET @strForLike = SUBSTRING(@str, 0, @pos)
			SET @str = RTRIM(LTRIM(SUBSTRING(@str, @pos + 1, LEN(@str) - @pos)))
		END
	ELSE
		BEGIN
			SET @strForLike = @str
			SET @str = ''
		END
		
	SET @LikeStr = @LikeStr + ' AND NOT(aVisitInit LIKE ''%' + @strForLike + '%'')'
END

SELECT SUBSTRING(@LikeStr, 5, LEN(@LIkeStr) - 4)</Text>
      <XSLT />
      <ImageName />
      <Params />
    </Query>
    <Query>
      <Code>0</Code>
      <Name>Áàëëàíñ ðàáî÷åãî âðåìåíè\Áàëàíñ ðàáî÷åãî âðåìåíè</Name>
      <DateCreate>2010-06-02T12:46:20.8646032+03:00</DateCreate>
      <DateLastModified>2015-08-07T00:00:00+03:00</DateLastModified>
      <Hidden>true</Hidden>
      <Author>M.Tor</Author>
      <Note />
      <Text>
/**
	Áàëàíñ ðàáî÷åãî âðåìåíè
*/

SET dateformat dmy

DECLARE @dtFrom datetime, @dtTo datetime
SET @dtFrom = CAST(CONVERT (varchar(16), #?pDateFrom?#, 104) as datetime)
SET @dtTo = DATEADD(d, 1, CAST(CONVERT (varchar(16), #?pDateTo?#, 104) as datetime))

DECLARE @BWDay AS varchar(10), @FWDay AS varchar(10)
DECLARE @CriticalPeriodIn int, @CriticalPeriodOut int
DECLARE @WDRangeSec int

SET @BWDay = ' 09:00:00' -- íà÷àëî ðàáî÷åãî äíÿ !!! ïðîáåë â íà÷àëå ÎÁßÇÀÒÅËÅÍ
SET @FWDay = ' 18:00:00' -- îêîí÷àíèå ðàáî÷åãî äíÿ !!! ïðîáåë â íà÷àëå ÎÁßÇÀÒÅËÅÍ
SET @CriticalPeriodIn = #?pCriticalIn?#*60 -- èíòåðâàë âðåìåíè (ñåê.) ñ÷èòàþùèéñÿ îïîçäàíèåì ïðèõîäà
SET @CriticalPeriodOut = #?pCriticalOut?#*60 -- èíòåðâàë âðåìåíè (ñåê.) ñ÷èòàþùèéñÿ ðàííèì óõîäîì
SET @WDRangeSec = 9*3600 -- ïðîäîëæèòåëüíîñòü ðàáî÷åãî äíÿ (ñåê.)

DECLARE  @TInOut table 
	(aDate varchar(20), aTimeIn datetime, aTimeOut datetime, aUserID int, aUser varchar(255))
DECLARE  @TInOutWDE table 
	(aDate varchar(20), aTimeIn datetime, aTimeOut datetime, aUserID int, aUser varchar(255), aWDay int, aDelayIn int, aEarlyOut int)
DECLARE @TSumCountDE table
	(aUserID int, aUser varchar(255)
	,aSumWDay int, aCountWDay int
	,aSumDelayIn int, aCountDelayIn int
	,aSumEarlyOut int, aCountEarlyOut int)
	
INSERT @TInOut
SELECT 
	CONVERT(varchar(20), TransLog.TranDateTime, 104)
	,MIN(TransLog.TranDateTime)
	,MAX(TransLog.TranDateTime)
	,TransLog.TranUserID
	,TransLog.TranUser
FROM 
	TransLog
		INNER JOIN Personel ON TransLog.TranUserID=Personel.ID_USER
WHERE
	TransLog.TranDateTime &gt;= @dtFrom
	AND TransLog.TranDateTime &lt; @dtTo
--	AND LEN(ISNULL(Personel.Extra3,'')) &gt; 0
	#?pFltDep?#
GROUP BY 
	CONVERT(varchar(20), TransLog.TranDateTime, 104),TransLog.TranUserID,TransLog.TranUser

INSERT @TInOutWDE
SELECT 
	aDate
	,aTimeIn
	,aTimeOut
	,aUserID, aUser
	,DATEDIFF(s, aTimeIn, aTimeOut) AS aWDay
	,CASE 
		WHEN DATEDIFF(s, CAST(aDate+@BWDay AS datetime) , aTimeIn) &gt; 0 AND DATEDIFF(s, CAST(aDate+@BWDay AS datetime) , aTimeIn) &lt; @CriticalPeriodIn
			THEN DATEDIFF(s, CAST(aDate+@BWDay AS datetime) , aTimeIn)
		ELSE null	
	  END AS aDelayIn
	,CASE 
		WHEN DATEDIFF(s, aTimeOut, CAST(aDate+@FWDay AS datetime)) &gt; 0 AND DATEDIFF(s, aTimeOut, CAST(aDate+@FWDay AS datetime)) &lt; @CriticalPeriodOut
			THEN DATEDIFF(s, aTimeOut, CAST(aDate+@FWDay AS datetime))
		ELSE null	
	  END AS aEarlyOut
FROM
	@TInOut

INSERT @TSumCountDE	
SELECT 
	aUserID, aUser
	,ISNULL(SUM(aWDay), 0)
	,ISNULL(COUNT(aWDay), 0)
	,ISNULL(SUM(aDelayIn), 0)
	,ISNULL(COUNT(aDelayIn), 0)
	,ISNULL(SUM(aEarlyOut), 0)
	,ISNULL(COUNT(aEarlyOut), 0)
FROM
	@TInOutWDE
GROUP BY aUserID, aUser

SELECT
	aUserID, aUser
	-- Êîë-âî ïðèõîäîâ íà ðàáîòó
	,aCountWDay 
	-- Ñóììàðíîå ðàá. âðåìÿ çà ìåñÿö
	,CAST(CAST(aSumWDay/3600 as int) as varchar(8))+' ÷., '+CAST(CAST((aSumWDay%3600)/60 as int) as varchar(8))+' ìèí.' AS aWHourMinute
	-- Îòêëîíåíèå îò íîðìàòèâà
	,CASE WHEN (aSumWDay-@WDRangeSec*aCountWDay) &gt; 0 THEN '' ELSE '-' END	
		+ CAST(CAST(ABS(aSumWDay-@WDRangeSec*aCountWDay)/3600 as int) as varchar(8))+' ÷., '+CAST(CAST((ABS(aSumWDay-@WDRangeSec*aCountWDay)%3600)/60 as int) as varchar(8))+' ìèí.' AS aWÂDifHourMinute 
	-- Ñðåäíÿÿ ïðîäîëæèòåëüíîñòü ðàá.äíÿ
	,CAST(CAST(aSumWDay/aCountWDay/3600 as int) as varchar(8))+' ÷., '+CAST(CAST(((aSumWDay/aCountWDay)%3600)/60 as int) as varchar(8))+' ìèí.' AS aWAvgHourMinute
	-- Íåñâîåâðåìåííûé ïðèõîä êîë-âî
	,aCountDelayIn
	-- Íåñâîåâðåìåííûé ïðèõîä ñóìì.âðåìÿ
	,CASE WHEN aCountDelayIn &gt; 0
		THEN CAST(CAST(aSumDelayIn/3600 as int) as varchar(8))+' ÷., '+CAST(CAST((aSumDelayIn%3600)/60 as int) as varchar(8))+' ìèí.'
		ELSE '-'
	END AS aDelayHourMinute
	-- Íåñâîåâðåìåííûé óõîä êîë-âî
	,aCountEarlyOut
	-- Íåñâîåâðåìåííûé óõîä ñóìì.âðåìÿ
	,CASE WHEN aCountEarlyOut &gt; 0
		THEN CAST(CAST(aSumEarlyOut/3600 as int) as varchar(8))+' ÷., '+CAST(CAST((aSumEarlyOut%3600)/60 as int) as varchar(8))+' ìèí.' 
		ELSE '-'
	END AS aEarlyHourMinute
FROM 
	@TSumCountDE
ORDER BY 2

SELECT TOP 1
	CASE 
		WHEN LEN('#?pFltDep?#') = 0 THEN '[Â Ñ Å]'
		WHEN Personel.Dep_ID &gt; 0 THEN Depart.DeptName
		ELSE '[âíå ïîäðàçäåëåíèé]'
	END  AS aDepName
FROM
	Personel LEFT JOIN Depart ON Personel.Dep_ID=Depart.ID_DEP
WHERE
	1=1
	#?pFltDep?#

/*	
                    &lt;TFOOT&gt;
                        &lt;TR class="GridCaption"&gt;
                            &lt;TD colspan="10"&gt;&lt;xsl:text disable-output-escaping="yes"&gt;&amp;amp;nbsp;&lt;/xsl:text&gt;&lt;/TD&gt;
                        &lt;/TR&gt;
                    &lt;/TFOOT&gt;
*/	

	
SELECT 
	aUserID, aUser
	,aDate
	,CONVERT(varchar(50), aTimeIn, 120)
	,CONVERT(varchar(50), aTimeOut, 120)
	,aWDay
	,aDelayIn
	,aEarlyOut
FROM
	@TInOutWDE

</Text>
      <XSLT>&lt;?xml version="1.0" encoding="Windows-1251" ?&gt;
&lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
&lt;xsl:output method="xml" version="1.0" encoding="windows-1251" indent="yes"/&gt;
	&lt;xsl:template match="/Query2DS"&gt;
		&lt;HTML&gt;
			&lt;HEAD&gt;
				&lt;TITLE&gt;Áàëàíñ ðàáî÷åãî âðåìåíè&lt;/TITLE&gt;
			&lt;/HEAD&gt;         
            
			&lt;BODY bgcolor="#FFFFFF"&gt;
				&lt;P class="Caption"&gt;
					Áàëàíñ ðàáî÷åãî âðåìåíè ñîòðóäíèêîâ ÕÊ "ÈÍÒÅÐÐÎÑ" çà ïåðèîä ñ 
					&lt;font class="Param"&gt;
						#?pDateFrom?#
					&lt;/font&gt; äî
                    &lt;font class="Param"&gt;
						#?pDateTo?#
					&lt;/font&gt;
					&lt;TABLE width="50%"&gt;
					&lt;TR&gt;&lt;TD align="right"&gt;Îáúåêò:&lt;/TD&gt;&lt;TD&gt;#?pObjectName?#&lt;/TD&gt;&lt;/TR&gt;
					&lt;TR&gt;&lt;TD align="right"&gt;Ïîäðàçäåëåíèå:&lt;/TD&gt;&lt;TD&gt;&lt;xsl:value-of select="Query2Table2/aDepName" /&gt;&lt;/TD&gt;&lt;/TR&gt;
					&lt;/TABLE&gt;
				&lt;/P&gt;
				
				&lt;TABLE width="100%" border="1" ID="GridTable" onclick="sortColumn(event)"&gt;
					&lt;!-- ÷òîáû øàïêà òàáëèöû ïîÿâëÿëàñü íà êàæäîé ñòðàíèöå ïðè ïå÷àòè --&gt;
					&lt;THEAD class="GridCaption"&gt;                     
						&lt;TR&gt;
							&lt;TD align="center" rowspan="2" width="3%"&gt;¹ ï/ï&lt;/TD&gt;
							&lt;TD align="center" rowspan="2" width="15%"&gt;Ô.È.Î. Ñîòðóäíèêà&lt;/TD&gt;
							&lt;TD align="center" rowspan="2" width="3%"&gt;Êîë-âî ðàá.äíåé&lt;/TD&gt;
                            &lt;TD align="center" rowspan="2" width="10%"&gt;Ñóììàðíîå ðàá. âðåìÿ çà ìåñÿö&lt;/TD&gt;
							&lt;TD align="center" rowspan="2" width="10%"&gt;Îòêëîíåíèå îò íîðìàòèâà (9 ÷àñ. â äåíü)&lt;/TD&gt;
							&lt;TD align="center" rowspan="2" width="10%"&gt;Ñðåäíÿÿ ïðîäîëæèò-òü ðàá.äíÿ&lt;/TD&gt;
							&lt;TD align="center" colspan="2"&gt;Íåñâîåâðåìåííûé ïðèõîä (ïîñëå 9 ÷. - #?pCriticalIn?# ìèí.)&lt;/TD&gt;
							&lt;TD align="center" colspan="2"&gt;Íåñâîåâðåìåííûé óõîä (äî 18 ÷. - #?pCriticalOut?# ìèí.)&lt;/TD&gt;
						&lt;/TR&gt;
                        &lt;TR&gt;
                            &lt;TD align="center" width="3%"&gt;Êîë-âî&lt;/TD&gt;
							&lt;TD align="center" width="10%"&gt;Ñóìì.âðåìÿ&lt;/TD&gt;
                            &lt;TD align="center" width="3%"&gt;Êîë-âî&lt;/TD&gt;
							&lt;TD align="center" width="10%"&gt;Ñóìì.âðåìÿ&lt;/TD&gt;
                        &lt;/TR&gt;
					&lt;/THEAD&gt;
					&lt;TBODY id="TBody"&gt;
						&lt;xsl:for-each select="Query2Table"&gt;
                            &lt;xsl:comment&gt;Âîäèòåëü â ðåçåðâå äî ïðèâÿçêè ê àâòîìîáèëþ&lt;/xsl:comment&gt;
							&lt;TR class="GridValue"&gt;
								&lt;TD&gt;&lt;xsl:number/&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aUser" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aCountWDay" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aWHourMinute" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aWÂDifHourMinute" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aWAvgHourMinute" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aCountDelayIn" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aDelayHourMinute" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aCountEarlyOut" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aEarlyHourMinute" /&gt;&lt;/TD&gt;
							&lt;/TR&gt;
						&lt;/xsl:for-each&gt;                        
					&lt;/TBODY&gt;
				&lt;/TABLE&gt;
			&lt;/BODY&gt;
		&lt;/HTML&gt;
	&lt;/xsl:template&gt;
&lt;/xsl:stylesheet&gt;
</XSLT>
      <ImageName />
      <Params>
        <Param>
          <Number>1</Number>
          <Title>Îáúåêò</Title>
          <Name>pObjectName</Name>
          <Type>String</Type>
          <Inset>true</Inset>
          <CurrentValue>Íàçâàíèå îáúåêòà</CurrentValue>
          <DefaultValue />
          <SelectValue />
        </Param>
        <Param>
          <Number>2</Number>
          <Title>Çà ïåðèîä ñ </Title>
          <Name>pDateFrom</Name>
          <Type>Date</Type>
          <Inset>false</Inset>
          <CurrentValue>01.04.2015</CurrentValue>
          <DefaultValue />
          <SelectValue />
        </Param>
        <Param>
          <Number>4</Number>
          <Title>ïî</Title>
          <Name>pDateTo</Name>
          <Type>Date</Type>
          <Inset>false</Inset>
          <CurrentValue>30.04.2015</CurrentValue>
          <DefaultValue />
          <SelectValue />
        </Param>
        <Param>
          <Number>6</Number>
          <Title>Ïîäðàçäåëåíèå</Title>
          <Name>pFltDep</Name>
          <Type>StrSelectList</Type>
          <Inset>true</Inset>
          <CurrentValue />
          <DefaultValue />
          <SelectValue>~ÂÑÅ
;
AND Personel.Dep_ID is null~[âíå ïîäðàçäåëåíèé]
;
SET dateformat dmy
DECLARE @dtTo datetime
SET @dtTo = DATEADD(d, 1, CAST(CONVERT (varchar(16), #?pDateTo?#,104) as datetime))
SELECT DISTINCT
	'AND Personel.Dep_ID = '+CAST(Depart.ID_DEP AS varchar(16)),
	Depart.DeptName
FROM
	TransLog
		INNER JOIN Personel ON TransLog.TranUserID=Personel.ID_USER
		INNER JOIN Depart ON Personel.Dep_ID=Depart.ID_DEP
WHERE
	TransLog.TranDateTime &gt;= #?pDateFrom?#
	AND TransLog.TranDateTime &lt; @dtTo
ORDER BY 2
</SelectValue>
        </Param>
        <Param>
          <Number>10</Number>
          <Title>Èíòåðâàë âðåìåíè  (â ìèí.) c 9 ÷., ñ÷èòàþùèéñÿ îïîçäàíèåì ïðèõîäà</Title>
          <Name>pCriticalIn</Name>
          <Type>Integer</Type>
          <Inset>true</Inset>
          <CurrentValue />
          <DefaultValue>60</DefaultValue>
          <SelectValue>60</SelectValue>
        </Param>
        <Param>
          <Number>12</Number>
          <Title>Èíòåðâàë âðåìåíè (â ìèí.) äî 18 ÷., ñ÷èòàþùèéñÿ ðàííèì óõîäîì</Title>
          <Name>pCriticalOut</Name>
          <Type>Integer</Type>
          <Inset>true</Inset>
          <CurrentValue />
          <DefaultValue>60</DefaultValue>
          <SelectValue>60</SelectValue>
        </Param>
      </Params>
    </Query>
    <Query>
      <Code>0</Code>
      <Name>Áàëëàíñ ðàáî÷åãî âðåìåíè\Áàëàíñ ðàáî÷åãî âðåìåíè V2</Name>
      <DateCreate>2010-06-02T12:46:20.8646032+03:00</DateCreate>
      <DateLastModified>2011-02-08T00:00:00+03:00</DateLastModified>
      <Hidden>true</Hidden>
      <Author>M.Tor</Author>
      <Note />
      <Text>
/**
	Áàëàíñ ðàáî÷åãî âðåìåíè
*/

SET dateformat dmy

DECLARE @dtFrom datetime, @dtTo datetime
SET @dtFrom = CAST(CONVERT (varchar(16), #?pDateFrom?#, 104) as datetime)
SET @dtTo = DATEADD(d, 1, CAST(CONVERT (varchar(16), #?pDateTo?#, 104) as datetime))

DECLARE @BWDay AS varchar(10), @FWDay AS varchar(10)
DECLARE @CriticalPeriodIn int, @CriticalPeriodOut int
DECLARE @WDRangeSec int

SET @BWDay = ' 09:00:00' -- íà÷àëî ðàáî÷åãî äíÿ !!! ïðîáåë â íà÷àëå ÎÁßÇÀÒÅËÅÍ
SET @FWDay = ' 18:00:00' -- îêîí÷àíèå ðàáî÷åãî äíÿ !!! ïðîáåë â íà÷àëå ÎÁßÇÀÒÅËÅÍ
SET @CriticalPeriodIn = #?pCriticalIn?#*60 -- èíòåðâàë âðåìåíè (ñåê.) ñ÷èòàþùèéñÿ îïîçäàíèåì ïðèõîäà
SET @CriticalPeriodOut = #?pCriticalOut?#*60 -- èíòåðâàë âðåìåíè (ñåê.) ñ÷èòàþùèéñÿ ðàííèì óõîäîì
SET @WDRangeSec = 9*3600 -- ïðîäîëæèòåëüíîñòü ðàáî÷åãî äíÿ (ñåê.)

DECLARE  @TInOut table 
	(aDate varchar(20), aTimeIn datetime, aTimeOut datetime, aUserID int, aUser varchar(255))
DECLARE  @TInOutWDE table 
	(aDate varchar(20), aTimeIn datetime, aTimeOut datetime, aUserID int, aUser varchar(255), aWDay int, aDelayIn int, aEarlyOut int)
DECLARE @TSumCountDE table
	(aUserID int, aUser varchar(255)
	,aSumWDay int, aCountWDay int
	,aSumDelayIn int, aCountDelayIn int
	,aSumEarlyOut int, aCountEarlyOut int)
	
INSERT @TInOut
SELECT 
	CONVERT(varchar(20), TransLog.TranDateTime, 104)
	,MIN(TransLog.TranDateTime)
	,MAX(TransLog.TranDateTime)
	,TransLog.TranUserID
	,TransLog.TranUser
FROM 
	TransLog
		INNER JOIN Personel ON TransLog.TranUserID=Personel.ID_USER
		INNER JOIN 
		(
			SELECT D1.ID_DEP AS DD 
				FROM Depart AS D1 
					#?pFltDep?#
			UNION
			SELECT D2.ID_DEP AS DD 
				FROM Depart AS D1 
					INNER JOIN Depart AS D2 ON D1.ID_DEP=D2.Parent_ID
					#?pFltDep?#
			UNION
			SELECT D3.ID_DEP AS DD 
				FROM Depart AS D1 
					INNER JOIN Depart AS D2 ON D1.ID_DEP=D2.Parent_ID
					INNER JOIN Depart AS D3 ON D2.ID_DEP=D3.Parent_ID
					#?pFltDep?#
			UNION
			SELECT D4.ID_DEP AS DD 
				FROM Depart AS D1 
					INNER JOIN Depart AS D2 ON D1.ID_DEP=D2.Parent_ID
					INNER JOIN Depart AS D3 ON D2.ID_DEP=D3.Parent_ID
					INNER JOIN Depart AS D4 ON D3.ID_DEP=D4.Parent_ID
					#?pFltDep?#
			UNION
			SELECT D5.ID_DEP AS DD 
				FROM Depart AS D1 
					INNER JOIN Depart AS D2 ON D1.ID_DEP=D2.Parent_ID
					INNER JOIN Depart AS D3 ON D2.ID_DEP=D3.Parent_ID
					INNER JOIN Depart AS D4 ON D3.ID_DEP=D4.Parent_ID
					INNER JOIN Depart AS D5 ON D4.ID_DEP=D5.Parent_ID
					#?pFltDep?#
			UNION
			SELECT D6.ID_DEP AS DD 
				FROM Depart AS D1 
					INNER JOIN Depart AS D2 ON D1.ID_DEP=D2.Parent_ID
					INNER JOIN Depart AS D3 ON D2.ID_DEP=D3.Parent_ID
					INNER JOIN Depart AS D4 ON D3.ID_DEP=D4.Parent_ID
					INNER JOIN Depart AS D5 ON D4.ID_DEP=D5.Parent_ID
					INNER JOIN Depart AS D6 ON D5.ID_DEP=D6.Parent_ID
					#?pFltDep?#
			UNION
			SELECT D7.ID_DEP AS DD 
				FROM Depart AS D1 
					INNER JOIN Depart AS D2 ON D1.ID_DEP=D2.Parent_ID
					INNER JOIN Depart AS D3 ON D2.ID_DEP=D3.Parent_ID
					INNER JOIN Depart AS D4 ON D3.ID_DEP=D4.Parent_ID
					INNER JOIN Depart AS D5 ON D4.ID_DEP=D5.Parent_ID
					INNER JOIN Depart AS D6 ON D5.ID_DEP=D6.Parent_ID
					INNER JOIN Depart AS D7 ON D6.ID_DEP=D7.Parent_ID
					#?pFltDep?#
		) AS DEP ON Personel.Dep_ID = DEP.DD
WHERE
	TransLog.TranDateTime &gt;= @dtFrom
	AND TransLog.TranDateTime &lt; @dtTo
	AND LEN(ISNULL(Personel.Extra3,'')) &gt; 0
GROUP BY 
	CONVERT(varchar(20), TransLog.TranDateTime, 104),TransLog.TranUserID,TransLog.TranUser

INSERT @TInOutWDE
SELECT 
	aDate
	,aTimeIn
	,aTimeOut
	,aUserID, aUser
	,DATEDIFF(s, aTimeIn, aTimeOut) AS aWDay
	,CASE 
		WHEN DATEDIFF(s, CAST(aDate+@BWDay AS datetime) , aTimeIn) &gt; 0 AND DATEDIFF(s, CAST(aDate+@BWDay AS datetime) , aTimeIn) &lt; @CriticalPeriodIn
			THEN DATEDIFF(s, CAST(aDate+@BWDay AS datetime) , aTimeIn)
		ELSE null	
	  END AS aDelayIn
	,CASE 
		WHEN DATEDIFF(s, aTimeOut, CAST(aDate+@FWDay AS datetime)) &gt; 0 AND DATEDIFF(s, aTimeOut, CAST(aDate+@FWDay AS datetime)) &lt; @CriticalPeriodOut
			THEN DATEDIFF(s, aTimeOut, CAST(aDate+@FWDay AS datetime))
		ELSE null	
	  END AS aEarlyOut
FROM
	@TInOut

INSERT @TSumCountDE	
SELECT 
	aUserID, aUser
	,ISNULL(SUM(aWDay), 0)
	,ISNULL(COUNT(aWDay), 0)
	,ISNULL(SUM(aDelayIn), 0)
	,ISNULL(COUNT(aDelayIn), 0)
	,ISNULL(SUM(aEarlyOut), 0)
	,ISNULL(COUNT(aEarlyOut), 0)
FROM
	@TInOutWDE
GROUP BY aUserID, aUser

SELECT
	aUserID, aUser
	-- Êîë-âî ïðèõîäîâ íà ðàáîòó
	,aCountWDay 
	-- Ñóììàðíîå ðàá. âðåìÿ çà ìåñÿö
	,CAST(CAST(aSumWDay/3600 as int) as varchar(8))+' ÷., '+CAST(CAST((aSumWDay%3600)/60 as int) as varchar(8))+' ìèí.' AS aWHourMinute
	-- Îòêëîíåíèå îò íîðìàòèâà
	,CASE WHEN (aSumWDay-@WDRangeSec*aCountWDay) &gt; 0 THEN '' ELSE '-' END	
		+ CAST(CAST(ABS(aSumWDay-@WDRangeSec*aCountWDay)/3600 as int) as varchar(8))+' ÷., '+CAST(CAST((ABS(aSumWDay-@WDRangeSec*aCountWDay)%3600)/60 as int) as varchar(8))+' ìèí.' AS aWÂDifHourMinute 
	-- Ñðåäíÿÿ ïðîäîëæèòåëüíîñòü ðàá.äíÿ
	,CAST(CAST(aSumWDay/aCountWDay/3600 as int) as varchar(8))+' ÷., '+CAST(CAST(((aSumWDay/aCountWDay)%3600)/60 as int) as varchar(8))+' ìèí.' AS aWAvgHourMinute
	-- Íåñâîåâðåìåííûé ïðèõîä êîë-âî
	,aCountDelayIn
	-- Íåñâîåâðåìåííûé ïðèõîä ñóìì.âðåìÿ
	,CASE WHEN aCountDelayIn &gt; 0
		THEN CAST(CAST(aSumDelayIn/3600 as int) as varchar(8))+' ÷., '+CAST(CAST((aSumDelayIn%3600)/60 as int) as varchar(8))+' ìèí.'
		ELSE '-'
	END AS aDelayHourMinute
	-- Íåñâîåâðåìåííûé óõîä êîë-âî
	,aCountEarlyOut
	-- Íåñâîåâðåìåííûé óõîä ñóìì.âðåìÿ
	,CASE WHEN aCountEarlyOut &gt; 0
		THEN CAST(CAST(aSumEarlyOut/3600 as int) as varchar(8))+' ÷., '+CAST(CAST((aSumEarlyOut%3600)/60 as int) as varchar(8))+' ìèí.' 
		ELSE '-'
	END AS aEarlyHourMinute
FROM 
	@TSumCountDE
ORDER BY 2

SELECT TOP 1
	CASE 
		WHEN LEN('#?pFltDep?#') = 0 THEN '[Â Ñ Å]'
		ELSE D1.DeptName
	END  AS aDepName
FROM
	Depart AS D1
#?pFltDep?#

/*	
                    &lt;TFOOT&gt;
                        &lt;TR class="GridCaption"&gt;
                            &lt;TD colspan="10"&gt;&lt;xsl:text disable-output-escaping="yes"&gt;&amp;amp;nbsp;&lt;/xsl:text&gt;&lt;/TD&gt;
                        &lt;/TR&gt;
                    &lt;/TFOOT&gt;
*/	

	
SELECT 
	aUserID, aUser
	,aDate
	,CONVERT(varchar(50), aTimeIn, 120)
	,CONVERT(varchar(50), aTimeOut, 120)
	,aWDay
	,aDelayIn
	,aEarlyOut
FROM
	@TInOutWDE


SELECT * FROM @TInOut

SELECT * FROM @TInOutWDE</Text>
      <XSLT>&lt;?xml version="1.0" encoding="Windows-1251" ?&gt;
&lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
&lt;xsl:output method="xml" version="1.0" encoding="windows-1251" indent="yes"/&gt;
	&lt;xsl:template match="/Query2DS"&gt;
		&lt;HTML&gt;
			&lt;HEAD&gt;
				&lt;TITLE&gt;Áàëàíñ ðàáî÷åãî âðåìåíè&lt;/TITLE&gt;
			&lt;/HEAD&gt;         
            
			&lt;BODY bgcolor="#FFFFFF"&gt;
				&lt;P class="Caption"&gt;
					Áàëàíñ ðàáî÷åãî âðåìåíè ñîòðóäíèêîâ ÕÊ "ÈÍÒÅÐÐÎÑ" çà ïåðèîä ñ 
					&lt;font class="Param"&gt;
						#?pDateFrom?#
					&lt;/font&gt; äî
                    &lt;font class="Param"&gt;
						#?pDateTo?#
					&lt;/font&gt;
					&lt;TABLE width="50%"&gt;
					&lt;TR&gt;&lt;TD align="right"&gt;Îáúåêò:&lt;/TD&gt;&lt;TD&gt;#?pObjectName?#&lt;/TD&gt;&lt;/TR&gt;
					&lt;TR&gt;&lt;TD align="right"&gt;Ïîäðàçäåëåíèå:&lt;/TD&gt;&lt;TD&gt;&lt;xsl:value-of select="Query2Table2/aDepName" /&gt;&lt;/TD&gt;&lt;/TR&gt;
					&lt;/TABLE&gt;
				&lt;/P&gt;
				
				&lt;TABLE width="100%" border="1" ID="GridTable" onclick="sortColumn(event)"&gt;
					&lt;!-- ÷òîáû øàïêà òàáëèöû ïîÿâëÿëàñü íà êàæäîé ñòðàíèöå ïðè ïå÷àòè --&gt;
					&lt;THEAD class="GridCaption"&gt;                     
						&lt;TR&gt;
							&lt;TD align="center" rowspan="2" width="3%"&gt;¹ ï/ï&lt;/TD&gt;
							&lt;TD align="center" rowspan="2" width="15%"&gt;Ô.È.Î. Ñîòðóäíèêà&lt;/TD&gt;
							&lt;TD align="center" rowspan="2" width="3%"&gt;Êîë-âî ðàá.äíåé&lt;/TD&gt;
                            &lt;TD align="center" rowspan="2" width="10%"&gt;Ñóììàðíîå ðàá. âðåìÿ çà ìåñÿö&lt;/TD&gt;
							&lt;TD align="center" rowspan="2" width="10%"&gt;Îòêëîíåíèå îò íîðìàòèâà (9 ÷àñ. â äåíü)&lt;/TD&gt;
							&lt;TD align="center" rowspan="2" width="10%"&gt;Ñðåäíÿÿ ïðîäîëæèò-òü ðàá.äíÿ&lt;/TD&gt;
							&lt;TD align="center" colspan="2"&gt;Íåñâîåâðåìåííûé ïðèõîä (ïîñëå 9 ÷. - #?pCriticalIn?# ìèí.)&lt;/TD&gt;
							&lt;TD align="center" colspan="2"&gt;Íåñâîåâðåìåííûé óõîä (äî 18 ÷. - #?pCriticalOut?# ìèí.)&lt;/TD&gt;
						&lt;/TR&gt;
                        &lt;TR&gt;
                            &lt;TD align="center" width="3%"&gt;Êîë-âî&lt;/TD&gt;
							&lt;TD align="center" width="10%"&gt;Ñóìì.âðåìÿ&lt;/TD&gt;
                            &lt;TD align="center" width="3%"&gt;Êîë-âî&lt;/TD&gt;
							&lt;TD align="center" width="10%"&gt;Ñóìì.âðåìÿ&lt;/TD&gt;
                        &lt;/TR&gt;
					&lt;/THEAD&gt;
					&lt;TBODY id="TBody"&gt;
						&lt;xsl:for-each select="Query2Table"&gt;
                            &lt;xsl:comment&gt;Âîäèòåëü â ðåçåðâå äî ïðèâÿçêè ê àâòîìîáèëþ&lt;/xsl:comment&gt;
							&lt;TR class="GridValue"&gt;
								&lt;TD&gt;&lt;xsl:number/&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aUser" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aCountWDay" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aWHourMinute" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aWÂDifHourMinute" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aWAvgHourMinute" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aCountDelayIn" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aDelayHourMinute" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aCountEarlyOut" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aEarlyHourMinute" /&gt;&lt;/TD&gt;
							&lt;/TR&gt;
						&lt;/xsl:for-each&gt;                        
					&lt;/TBODY&gt;
				&lt;/TABLE&gt;
			&lt;/BODY&gt;
		&lt;/HTML&gt;
	&lt;/xsl:template&gt;
&lt;/xsl:stylesheet&gt;
</XSLT>
      <ImageName />
      <Params>
        <Param>
          <Number>1</Number>
          <Title>Îáúåêò</Title>
          <Name>pObjectName</Name>
          <Type>String</Type>
          <Inset>true</Inset>
          <CurrentValue>Íàçâàíèå îáúåêòà</CurrentValue>
          <DefaultValue />
          <SelectValue />
        </Param>
        <Param>
          <Number>2</Number>
          <Title>Çà ïåðèîä ñ </Title>
          <Name>pDateFrom</Name>
          <Type>Date</Type>
          <Inset>false</Inset>
          <CurrentValue>01.02.2011</CurrentValue>
          <DefaultValue />
          <SelectValue />
        </Param>
        <Param>
          <Number>4</Number>
          <Title>ïî</Title>
          <Name>pDateTo</Name>
          <Type>Date</Type>
          <Inset>false</Inset>
          <CurrentValue>28.02.2011</CurrentValue>
          <DefaultValue />
          <SelectValue />
        </Param>
        <Param>
          <Number>6</Number>
          <Title>Ïîäðàçäåëåíèå</Title>
          <Name>pFltDep</Name>
          <Type>StrSelectTree</Type>
          <Inset>true</Inset>
          <CurrentValue>WHERE D1.ID_DEP = 5:Èíôîðìàöèîííî-Àíàëèòè÷åñêèé îòäåë</CurrentValue>
          <DefaultValue />
          <SelectValue>_idDep i 0
;
SELECT '', 'ÂÑÅ', 1, 0 
;
SELECT
	'WHERE D1.ID_DEP = '+CAST(Depart.ID_DEP AS varchar(16)),
	Depart.DeptName,
	COUNT(DC.ID_DEP),
	Depart.ID_DEP

FROM	
	Depart LEFT JOIN Depart AS DC ON Depart.ID_DEP=DC.Parent_ID
WHERE	
	ISNULL(Depart.Parent_ID, 0) = #?_idDep?#
GROUP BY
	' D1.ID_DEP = '+CAST(Depart.ID_DEP AS varchar(16)),
	Depart.DeptName,
	Depart.ID_DEP
ORDER BY 2
</SelectValue>
        </Param>
        <Param>
          <Number>10</Number>
          <Title>Èíòåðâàë âðåìåíè  (â ìèí.) c 9 ÷., ñ÷èòàþùèéñÿ îïîçäàíèåì ïðèõîäà</Title>
          <Name>pCriticalIn</Name>
          <Type>Integer</Type>
          <Inset>true</Inset>
          <CurrentValue />
          <DefaultValue>60</DefaultValue>
          <SelectValue>60</SelectValue>
        </Param>
        <Param>
          <Number>12</Number>
          <Title>Èíòåðâàë âðåìåíè (â ìèí.) äî 18 ÷., ñ÷èòàþùèéñÿ ðàííèì óõîäîì</Title>
          <Name>pCriticalOut</Name>
          <Type>Integer</Type>
          <Inset>true</Inset>
          <CurrentValue />
          <DefaultValue>60</DefaultValue>
          <SelectValue>60</SelectValue>
        </Param>
      </Params>
    </Query>
    <Query>
      <Code>0</Code>
      <Name>Áàëëàíñ ðàáî÷åãî âðåìåíè\Áàëàíñ ðàáî÷åãî âðåìåíè V3</Name>
      <DateCreate>2010-06-02T12:46:20.8646032+03:00</DateCreate>
      <DateLastModified>2015-08-07T00:00:00+03:00</DateLastModified>
      <Hidden>false</Hidden>
      <Author>M.Tor</Author>
      <Note />
      <Text>
/**
	Áàëàíñ ðàáî÷åãî âðåìåíè
*/

SET dateformat dmy

DECLARE @dtFrom datetime, @dtTo datetime
SET @dtFrom = CAST('01.#?pMonth?#.#?pYear?#' as datetime)
SET @dtTo = DATEADD(m, 1, @dtFrom)

DECLARE @BWDay AS varchar(10) --, @FWDay AS varchar(10)
DECLARE @CriticalPeriodIn int, @CriticalPeriodOut int
--DECLARE @WDRangeSec int

SET @BWDay = ' 09:00:00' -- íà÷àëî ðàáî÷åãî äíÿ !!! ïðîáåë â íà÷àëå ÎÁßÇÀÒÅËÅÍ
--SET @FWDay = ' 18:00:00' -- îêîí÷àíèå ðàáî÷åãî äíÿ !!! ïðîáåë â íà÷àëå ÎÁßÇÀÒÅËÅÍ
SET @CriticalPeriodIn = #?pCriticalIn?#*60 -- èíòåðâàë âðåìåíè (ñåê.) ñ÷èòàþùèéñÿ îïîçäàíèåì ïðèõîäà
SET @CriticalPeriodOut = #?pCriticalOut?#*60 -- èíòåðâàë âðåìåíè (ñåê.) ñ÷èòàþùèéñÿ ðàííèì óõîäîì
--SET @WDRangeSec = 9*3600 -- ïðîäîëæèòåëüíîñòü ðàáî÷åãî äíÿ (ñåê.)

DECLARE  @TInOut table 
	(aDate varchar(20), aTimeIn datetime, aTimeOut datetime, aUserID uniqueidentifier, aUser varchar(255), aWDRangeSec int, aFWDay varchar(10))
DECLARE  @TInOutWDE table 
	(aDate varchar(20), aTimeIn datetime, aTimeOut datetime, aUserID uniqueidentifier, aUser varchar(255), aWDay int, aDelayIn int, aEarlyOut int, aWDRangeSec int)
DECLARE @TSumCountDE table
	(aUserID uniqueidentifier, aUser varchar(255)
	,aSumWDay int, aCountWDay int
	,aSumDelayIn int, aCountDelayIn int
	,aSumEarlyOut int, aCountEarlyOut int
	,aSumWDRangeSec int)
	
INSERT @TInOut
SELECT 
	CONVERT(varchar(20), PTTL.TRAN_DATE, 104)
	,MIN(PTTL.TRAN_DATE)
	,MAX(PTTL.TRAN_DATE)
	,PTTL.USR_ID
	,PP.LAST_NAME+' '+PP.FIRST_NAME+' '+PP.MIDDLE_NAME
	,CASE 
		WHEN PATINDEX('%'+SUBSTRING(CONVERT(varchar(10),PTTL.TRAN_DATE,104),1,2)+'%','#?pFDay?#') &gt; 0 THEN 7*3600+45*60
		WHEN PATINDEX('%'+SUBSTRING(CONVERT(varchar(10),PTTL.TRAN_DATE,104),1,2)+'%','#?pHDay?#') &gt; 0 THEN 8*3600
		ELSE 9*3600
	END
	,CASE 
		WHEN PATINDEX('%'+SUBSTRING(CONVERT(varchar(10),PTTL.TRAN_DATE,104),1,2)+'%','#?pFDay?#') &gt; 0 THEN ' 16:45:00'
		WHEN PATINDEX('%'+SUBSTRING(CONVERT(varchar(10),PTTL.TRAN_DATE,104),1,2)+'%','#?pHDay?#') &gt; 0 THEN ' 17:00:00'
		ELSE ' 18:00:00'
	END
FROM 
	[Parsec3Trans].dbo.[TransLog] AS PTTL
		INNER JOIN [Parsec3].dbo.[Person] AS PP ON PTTL.USR_ID=PP.PERS_ID
		INNER JOIN 
		(
			SELECT D1.ORG_ID AS DD 
				FROM [Parsec3].[dbo].[ORGANIZATION] AS D1 
					#?pFltDep?#
			UNION
			SELECT D2.ORG_ID AS DD 
				FROM [Parsec3].[dbo].[ORGANIZATION] AS D1 
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D2 ON D1.ORG_ID=D2.PARENT_ID
					#?pFltDep?#
			UNION
			SELECT D3.ORG_ID AS DD 
				FROM [Parsec3].[dbo].[ORGANIZATION] AS D1 
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D2 ON D1.ORG_ID=D2.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D3 ON D2.ORG_ID=D3.PARENT_ID
					#?pFltDep?#
			UNION
			SELECT D4.ORG_ID AS DD 
				FROM [Parsec3].[dbo].[ORGANIZATION] AS D1 
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D2 ON D1.ORG_ID=D2.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D3 ON D2.ORG_ID=D3.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D4 ON D3.ORG_ID=D4.PARENT_ID
					#?pFltDep?#
			UNION
			SELECT D5.ORG_ID AS DD 
				FROM [Parsec3].[dbo].[ORGANIZATION] AS D1 
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D2 ON D1.ORG_ID=D2.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D3 ON D2.ORG_ID=D3.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D4 ON D3.ORG_ID=D4.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D5 ON D4.ORG_ID=D5.PARENT_ID
					#?pFltDep?#
			UNION
			SELECT D6.ORG_ID AS DD 
				FROM [Parsec3].[dbo].[ORGANIZATION] AS D1 
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D2 ON D1.ORG_ID=D2.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D3 ON D2.ORG_ID=D3.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D4 ON D3.ORG_ID=D4.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D5 ON D4.ORG_ID=D5.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D6 ON D5.ORG_ID=D6.PARENT_ID
					#?pFltDep?#
			UNION
			SELECT D7.ORG_ID AS DD 
				FROM [Parsec3].[dbo].[ORGANIZATION] AS D1 
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D2 ON D1.ORG_ID=D2.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D3 ON D2.ORG_ID=D3.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D4 ON D3.ORG_ID=D4.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D5 ON D4.ORG_ID=D5.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D6 ON D5.ORG_ID=D6.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D7 ON D6.ORG_ID=D7.PARENT_ID
					#?pFltDep?#
		) AS DEP ON PP.ORG_ID = DEP.DD
WHERE
	PTTL.TRAN_DATE &gt;= @dtFrom
	AND PTTL.TRAN_DATE &lt; @dtTo
--	AND LEN(ISNULL(Personel.Extra3,'')) &gt; 0
GROUP BY 
	CONVERT(varchar(20), PTTL.TRAN_DATE, 104)
	,PTTL.USR_ID
	,PP.LAST_NAME+' '+PP.FIRST_NAME+' '+PP.MIDDLE_NAME
	,CASE 
		WHEN PATINDEX('%'+SUBSTRING(CONVERT(varchar(10),PTTL.TRAN_DATE,104),1,2)+'%','#?pFDay?#') &gt; 0 THEN 7*3600+45*60
		WHEN PATINDEX('%'+SUBSTRING(CONVERT(varchar(10),PTTL.TRAN_DATE,104),1,2)+'%','#?pHDay?#') &gt; 0 THEN 8*3600
		ELSE 9*3600
	END
	,CASE 
		WHEN PATINDEX('%'+SUBSTRING(CONVERT(varchar(10),PTTL.TRAN_DATE,104),1,2)+'%','#?pFDay?#') &gt; 0 THEN ' 16:45:00'
		WHEN PATINDEX('%'+SUBSTRING(CONVERT(varchar(10),PTTL.TRAN_DATE,104),1,2)+'%','#?pHDay?#') &gt; 0 THEN ' 17:00:00'
		ELSE ' 18:00:00'
	END

INSERT @TInOutWDE
SELECT 
	aDate
	,aTimeIn
	,aTimeOut
	,aUserID, aUser
	,DATEDIFF(s, aTimeIn, aTimeOut) AS aWDay
	,CASE 
		WHEN DATEDIFF(s, CAST(aDate+@BWDay AS datetime) , aTimeIn) &gt; 0 AND DATEDIFF(s, CAST(aDate+@BWDay AS datetime) , aTimeIn) &lt; @CriticalPeriodIn
			THEN DATEDIFF(s, CAST(aDate+@BWDay AS datetime) , aTimeIn)
		ELSE null	
	  END AS aDelayIn
	,CASE 
		WHEN DATEDIFF(s, aTimeOut, CAST(aDate+aFWDay AS datetime)) &gt; 0 AND DATEDIFF(s, aTimeOut, CAST(aDate+aFWDay AS datetime)) &lt; @CriticalPeriodOut
			THEN DATEDIFF(s, aTimeOut, CAST(aDate+aFWDay AS datetime))
		ELSE null	
	  END AS aEarlyOut
	,aWDRangeSec
FROM
	@TInOut
WHERE LEN(aUser) &gt; 0

INSERT @TSumCountDE	
SELECT 
	aUserID, aUser
	,ISNULL(SUM(aWDay), 0)
	,ISNULL(COUNT(aWDay), 0)
	,ISNULL(SUM(aDelayIn), 0)
	,ISNULL(COUNT(aDelayIn), 0)
	,ISNULL(SUM(aEarlyOut), 0)
	,ISNULL(COUNT(aEarlyOut), 0)
	,ISNULL(SUM(aWDRangeSec), 0)
FROM
	@TInOutWDE
GROUP BY aUserID, aUser

SELECT
	aUserID, aUser
	-- Êîë-âî ïðèõîäîâ íà ðàáîòó
	,aCountWDay 
	-- Ñóììàðíîå ðàá. âðåìÿ çà ìåñÿö
	,CAST(CAST(aSumWDay/3600 as int) as varchar(8))+' ÷., '+CAST(CAST((aSumWDay%3600)/60 as int) as varchar(8))+' ìèí.' AS aWHourMinute
	-- Îòêëîíåíèå îò íîðìàòèâà
	,CASE WHEN (aSumWDay-aSumWDRangeSec) &gt; 0 THEN '' ELSE '-' END	
		+ CAST(CAST(ABS(aSumWDay-aSumWDRangeSec)/3600 as int) as varchar(8))+' ÷., '+CAST(CAST((ABS(aSumWDay-aSumWDRangeSec)%3600)/60 as int) as varchar(8))+' ìèí.' AS aWÂDifHourMinute 
	-- Ñðåäíÿÿ ïðîäîëæèòåëüíîñòü ðàá.äíÿ
	,CAST(CAST(aSumWDay/aCountWDay/3600 as int) as varchar(8))+' ÷., '+CAST(CAST(((aSumWDay/aCountWDay)%3600)/60 as int) as varchar(8))+' ìèí.' AS aWAvgHourMinute
	-- Íåñâîåâðåìåííûé ïðèõîä êîë-âî
	,aCountDelayIn
	-- Íåñâîåâðåìåííûé ïðèõîä ñóìì.âðåìÿ
	,CASE WHEN aCountDelayIn &gt; 0
		THEN CAST(CAST(aSumDelayIn/3600 as int) as varchar(8))+' ÷., '+CAST(CAST((aSumDelayIn%3600)/60 as int) as varchar(8))+' ìèí.'
		ELSE '-'
	END AS aDelayHourMinute
	-- Íåñâîåâðåìåííûé óõîä êîë-âî
	,aCountEarlyOut
	-- Íåñâîåâðåìåííûé óõîä ñóìì.âðåìÿ
	,CASE WHEN aCountEarlyOut &gt; 0
		THEN CAST(CAST(aSumEarlyOut/3600 as int) as varchar(8))+' ÷., '+CAST(CAST((aSumEarlyOut%3600)/60 as int) as varchar(8))+' ìèí.' 
		ELSE '-'
	END AS aEarlyHourMinute
FROM 
	@TSumCountDE
ORDER BY 2

SELECT TOP 1
	D1.ORG_NAME AS aDepName	
FROM
	(
		SELECT NEWID() AS ORG_ID, ' Â Ñ Å' AS ORG_NAME
		UNION ALL
		SELECT DD.ORG_ID AS ORG_ID, DD.ORG_NAME AS ORG_NAME
		FROM [Parsec3].[dbo].[ORGANIZATION] AS DD
		WHERE LEN(DD.ORG_NAME) &gt; 0
	) AS D1
#?pFltDep?#

/*	
                    &lt;TFOOT&gt;
                        &lt;TR class="GridCaption"&gt;
                            &lt;TD colspan="10"&gt;&lt;xsl:text disable-output-escaping="yes"&gt;&amp;amp;nbsp;&lt;/xsl:text&gt;&lt;/TD&gt;
                        &lt;/TR&gt;
                    &lt;/TFOOT&gt;
*/	

	
SELECT 
	aUserID, aUser
	,aDate
	,CONVERT(varchar(50), aTimeIn, 120)
	,CONVERT(varchar(50), aTimeOut, 120)
	,aWDay
	,aDelayIn
	,aEarlyOut
FROM
	@TInOutWDE


SELECT * FROM @TInOut

SELECT * FROM @TInOutWDE</Text>
      <XSLT>&lt;?xml version="1.0" encoding="Windows-1251" ?&gt;
&lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
&lt;xsl:output method="xml" version="1.0" encoding="windows-1251" indent="yes"/&gt;
	&lt;xsl:template match="/Query2DS"&gt;
		&lt;HTML&gt;
			&lt;HEAD&gt;
				&lt;TITLE&gt;Áàëàíñ ðàáî÷åãî âðåìåíè&lt;/TITLE&gt;
			&lt;/HEAD&gt;         
            
			&lt;BODY bgcolor="#FFFFFF"&gt;
				&lt;P class="Caption"&gt;
					Áàëàíñ ðàáî÷åãî âðåìåíè ñîòðóäíèêîâ ÕÊ "ÈÍÒÅÐÐÎÑ" çà
					&lt;font class="Param"&gt;#?pMonth?#.#?pYear?#&lt;/font&gt;
					&lt;TABLE width="50%"&gt;
					&lt;TR&gt;&lt;TD align="right"&gt;Îáúåêò:&lt;/TD&gt;&lt;TD&gt;#?pObjectName?#&lt;/TD&gt;&lt;/TR&gt;
					&lt;TR&gt;&lt;TD align="right"&gt;Ïîäðàçäåëåíèå:&lt;/TD&gt;&lt;TD&gt;&lt;xsl:value-of select="Query2Table2/aDepName" /&gt;&lt;/TD&gt;&lt;/TR&gt;
					&lt;/TABLE&gt;
				&lt;/P&gt;
				
				&lt;TABLE width="100%" border="1" ID="GridTable" onclick="sortColumn(event)"&gt;
					&lt;!-- ÷òîáû øàïêà òàáëèöû ïîÿâëÿëàñü íà êàæäîé ñòðàíèöå ïðè ïå÷àòè --&gt;
					&lt;THEAD class="GridCaption"&gt;                     
						&lt;TR&gt;
							&lt;TD align="center" rowspan="2" width="3%"&gt;¹ ï/ï&lt;/TD&gt;
							&lt;TD align="center" rowspan="2" width="15%"&gt;Ô.È.Î. Ñîòðóäíèêà&lt;/TD&gt;
							&lt;TD align="center" rowspan="2" width="3%"&gt;Êîë-âî ðàá.äíåé&lt;/TD&gt;
                            &lt;TD align="center" rowspan="2" width="10%"&gt;Ñóììàðíîå ðàá. âðåìÿ çà ìåñÿö&lt;/TD&gt;
							&lt;TD align="center" rowspan="2" width="10%"&gt;Îòêëîíåíèå îò íîðìàòèâà&lt;/TD&gt;
							&lt;TD align="center" rowspan="2" width="10%"&gt;Ñðåäíÿÿ ïðîäîëæèò-òü ðàá.äíÿ&lt;/TD&gt;
							&lt;TD align="center" colspan="2"&gt;Íåñâîåâðåìåííûé ïðèõîä (ïîñëå 9 ÷. - #?pCriticalIn?# ìèí.)&lt;/TD&gt;
							&lt;TD align="center" colspan="2"&gt;Íåñâîåâðåìåííûé óõîä (êîíåö ð.ä. - #?pCriticalOut?# ìèí.)&lt;/TD&gt;
						&lt;/TR&gt;
                        &lt;TR&gt;
                            &lt;TD align="center" width="3%"&gt;Êîë-âî&lt;/TD&gt;
							&lt;TD align="center" width="10%"&gt;Ñóìì.âðåìÿ&lt;/TD&gt;
                            &lt;TD align="center" width="3%"&gt;Êîë-âî&lt;/TD&gt;
							&lt;TD align="center" width="10%"&gt;Ñóìì.âðåìÿ&lt;/TD&gt;
                        &lt;/TR&gt;
					&lt;/THEAD&gt;
					&lt;TBODY id="TBody"&gt;
						&lt;xsl:for-each select="Query2Table"&gt;
                            &lt;xsl:comment&gt;Âîäèòåëü â ðåçåðâå äî ïðèâÿçêè ê àâòîìîáèëþ&lt;/xsl:comment&gt;
							&lt;TR class="GridValue"&gt;
								&lt;TD&gt;&lt;xsl:number/&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aUser" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aCountWDay" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aWHourMinute" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aWÂDifHourMinute" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aWAvgHourMinute" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aCountDelayIn" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aDelayHourMinute" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aCountEarlyOut" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aEarlyHourMinute" /&gt;&lt;/TD&gt;
							&lt;/TR&gt;
						&lt;/xsl:for-each&gt;                        
					&lt;/TBODY&gt;
				&lt;/TABLE&gt;
			&lt;/BODY&gt;
		&lt;/HTML&gt;
	&lt;/xsl:template&gt;
&lt;/xsl:stylesheet&gt;
</XSLT>
      <ImageName />
      <Params>
        <Param>
          <Number>1</Number>
          <Title>Îáúåêò</Title>
          <Name>pObjectName</Name>
          <Type>String</Type>
          <Inset>true</Inset>
          <CurrentValue>ÁÑ-25</CurrentValue>
          <DefaultValue />
          <SelectValue />
        </Param>
        <Param>
          <Number>2</Number>
          <Title>Ãîä</Title>
          <Name>pYear</Name>
          <Type>StrSelectList</Type>
          <Inset>true</Inset>
          <CurrentValue>2015:2015</CurrentValue>
          <DefaultValue />
          <SelectValue>2004~2004
2005~2005
2006~2006
2007~2007
2008~2008
2009~2009
2010~2010
2011~2011
2012~2012
2013~2013
2014~2014
2015~2015
2016~2016
2017~2017
2018~2018
2019~2019
2020~2020</SelectValue>
        </Param>
        <Param>
          <Number>4</Number>
          <Title>Ìåñÿö</Title>
          <Name>pMonth</Name>
          <Type>StrSelectList</Type>
          <Inset>true</Inset>
          <CurrentValue>05:Ìàé</CurrentValue>
          <DefaultValue />
          <SelectValue>01~ßíâàðü
02~Ôåâðàëü
03~Ìàðò
04~Àïðåëü
05~Ìàé
06~Èþíü
07~Èþëü
08~Àâãóñò
09~Ñåíòÿáðü
10~Îêòÿáðü
11~Íîÿáðü
12~Äåêàáðü</SelectValue>
        </Param>
        <Param>
          <Number>6</Number>
          <Title>Ïîäðàçäåëåíèå</Title>
          <Name>pFltDep</Name>
          <Type>StrSelectTree</Type>
          <Inset>true</Inset>
          <CurrentValue>:</CurrentValue>
          <DefaultValue />
          <SelectValue>_idDep s ''
;
SELECT '', 'ÂÑÅ', 1, 'e6397305-b408-4993-8d5b-6e7f1cea6d69' 
;
SELECT
	' WHERE CAST(D1.ORG_ID AS varchar(64)) = '''+CAST(Depart.ORG_ID AS varchar(64)) +''' ',
	Depart.ORG_NAME,
	COUNT(DC.ORG_ID),
	CAST(Depart.ORG_ID AS varchar(64))

FROM	
	[Parsec3].[dbo].[ORGANIZATION] AS Depart 
	LEFT JOIN [Parsec3].[dbo].[ORGANIZATION] AS DC 
	ON Depart.ORG_ID=DC.PARENT_ID
WHERE	
	CAST(Depart.PARENT_ID AS varchar(64)) = #?_idDep?#
GROUP BY
	' D1.ORG_ID = '+CAST(Depart.ORG_ID AS varchar(64)),
	Depart.ORG_NAME,
	Depart.ORG_ID
ORDER BY 2
</SelectValue>
        </Param>
        <Param>
          <Number>10</Number>
          <Title>Èíòåðâàë âðåìåíè  (â ìèí.) c 9 ÷., ñ÷èòàþùèéñÿ îïîçäàíèåì ïðèõîäà</Title>
          <Name>pCriticalIn</Name>
          <Type>Integer</Type>
          <Inset>true</Inset>
          <CurrentValue />
          <DefaultValue>60</DefaultValue>
          <SelectValue>60</SelectValue>
        </Param>
        <Param>
          <Number>12</Number>
          <Title>Èíòåðâàë âðåìåíè (â ìèí.) äî 18 ÷., ñ÷èòàþùèéñÿ ðàííèì óõîäîì</Title>
          <Name>pCriticalOut</Name>
          <Type>Integer</Type>
          <Inset>true</Inset>
          <CurrentValue />
          <DefaultValue>60</DefaultValue>
          <SelectValue>60</SelectValue>
        </Param>
        <Param>
          <Number>14</Number>
          <Title>Ñïèñîê óêîðî÷åííûõ äíåé - äåíü ìåñÿöà ñ ëèäèðóþùåì íóëåì ÷åðåç çàïÿòóþ (êîðî÷å íà 1 ÷àñ 15 ìèí.)</Title>
          <Name>pFDay</Name>
          <Type>String</Type>
          <Inset>true</Inset>
          <CurrentValue>04,11,18,25</CurrentValue>
          <DefaultValue />
          <SelectValue />
        </Param>
        <Param>
          <Number>16</Number>
          <Title>Ñïèñîê ïðåäïðàçíè÷íûõ äíåé - äåíü ìåñÿöà ñ ëèäèðóþùåì íóëåì ÷åðåç çàïÿòóþ (êîðî÷å íà 1 ÷àñ) </Title>
          <Name>pHDay</Name>
          <Type>String</Type>
          <Inset>true</Inset>
          <CurrentValue>22</CurrentValue>
          <DefaultValue />
          <SelectValue />
        </Param>
      </Params>
    </Query>
    <Query>
      <Code>0</Code>
      <Name>Áàëëàíñ ðàáî÷åãî âðåìåíè\Ãäå ñîòðóäíèê</Name>
      <DateCreate>2010-06-02T12:46:20.8646032+03:00</DateCreate>
      <DateLastModified>2010-06-07T23:00:00+03:00</DateLastModified>
      <Hidden>true</Hidden>
      <Author>M.Tor</Author>
      <Note />
      <Text>
SET dateformat dmy


--DECLARE  @TInOut table 
--	(aDate varchar(20), aTimeIn datetime, aTimeOut datetime, aUserID int, aUser varchar(255))
	
--INSERT @TInOut
SELECT TOP #?pStepCount?#
	CONVERT(varchar(20), TransLog.TranDateTime, 120) AS aDate_Time
	,TransLog.TranDesc AS aTrDescLog
	,TransDesc.TranDesc AS aTrDesc
	,TransLog.TranArea AS aDoorLog
	,Doors.AreaName AS aDoor
FROM 
	TransLog 
		INNER JOIN TransDesc ON TransLog.TranCode=TransDesc.TranCode
		INNER JOIN Doors ON TransLog.TranCtrlID=Doors.ID_DOOR
WHERE
	CAST(CONVERT(varchar(16), TranDateTime, 104) as datetime) = CAST(CONVERT(varchar(16), GETDATE(), 104) as datetime)
	#?pFltUser?#
ORDER BY TransLog.TranDateTime DESC
</Text>
      <XSLT />
      <ImageName />
      <Params>
        <Param>
          <Number>6</Number>
          <Title>Ñîòðóäíèê</Title>
          <Name>pFltUser</Name>
          <Type>StrSelectList</Type>
          <Inset>true</Inset>
          <CurrentValue> AND TransLog.TranUserID = 657:Ðóìÿíöåâ Ì. Ì.</CurrentValue>
          <DefaultValue />
          <SelectValue>SET dateformat dmy
SELECT DISTINCT
	' AND TransLog.TranUserID = '+CAST(TranUserID as varchar(16)),
	TranUser
FROM
	TransLog
WHERE
	TranDateTime &gt; DATEADD(mm, -6, GETDATE())
ORDER BY 2
</SelectValue>
        </Param>
        <Param>
          <Number>8</Number>
          <Title>Êîë-âî ñ÷èòûâàíèé</Title>
          <Name>pStepCount</Name>
          <Type>Integer</Type>
          <Inset>true</Inset>
          <CurrentValue />
          <DefaultValue />
          <SelectValue />
        </Param>
      </Params>
    </Query>
    <Query>
      <Code>0</Code>
      <Name>Áàëëàíñ ðàáî÷åãî âðåìåíè\Íåñàíêöèîíèðîâàííûé äîñòóï (ãðóïïèðîâêà ïî ïîìåùåíèÿì)</Name>
      <DateCreate>2010-06-04T12:56:34.2764898+03:00</DateCreate>
      <DateLastModified>2015-08-07T00:00:00+03:00</DateLastModified>
      <Hidden>false</Hidden>
      <Author>M.Tor</Author>
      <Note />
      <Text>SET dateformat dmy

DECLARE @dtFrom datetime, @dtTo datetime
SET @dtFrom = CAST(CONVERT (varchar(16), #?pDateFrom?#, 104) as datetime)
SET @dtTo = DATEADD(d, 1, CAST(CONVERT (varchar(16), #?pDateTo?#, 104) as datetime))

SELECT --TOP 10
	PTTL.[rid]
--	,PTTL.[TRAN_ID]
--	,PTTL.[PARENT_ID]
	,PTTL.[COMP_ID]
	,PTTL.[TRANTYPE_ID]
	,PTTL.[USR_ID]

	,PTER.TERRA_NAME AS aDoor
	,PP.LAST_NAME+' '+PP.FIRST_NAME+' '+PP.MIDDLE_NAME AS aUserName
	,CONVERT(varchar(50), DATEADD(hour, 3, PTTL.TRAN_DATE), 120) AS aDateTime
	,PTD.TRANTYPE_DESC AS TranDesc
	,PTTL.TRANTYPE_ID
	,PTT.[TRANCLASS_MASK]

FROM 
	[Parsec3Trans].dbo.[TransLog] AS PTTL
		INNER JOIN [Parsec3].dbo.[Person] AS PP ON PTTL.USR_ID=PP.PERS_ID
		INNER JOIN [Parsec3].[dbo].[TRANTYPES_DESC] AS PTD 
			ON PTTL.TRANTYPE_ID = PTD.TRANTYPE_ID
			AND PTD.LOCALE = 'RU'
		INNER JOIN [Parsec3].[dbo].[TRANTYPES] AS PTT
			ON PTTL.TRANTYPE_ID = PTT.TRANTYPE_ID
		INNER JOIN [Parsec3].[dbo].[TERRITORY] AS PTER
			ON PTTL.COMP_ID = PTER.ITEM_ID

WHERE
	DATEADD(hour, 3, PTTL.TRAN_DATE) &gt;= @dtFrom
	AND DATEADD(hour, 3, PTTL.TRAN_DATE) &lt; @dtTo
	AND PTTL.TRANTYPE_ID != 590113 -- ÐÐµÑ Ð´Ð¾ÑÑÑÐ¿Ð° Ð¿Ð¾ Ð±Ð»Ð¾ÐºÐ¸ÑÐ¾Ð²ÐºÐµ
	AND PTT.[TRANCLASS_MASK] &lt; 129
--	AND PTT.[TRANCLASS_MASK] &gt; 65535
--	AND PP.LAST_NAME LIKE 'ÐÑÐ±%'
ORDER BY aDoor,aUserName,aDateTime
</Text>
      <XSLT>&lt;?xml version="1.0" encoding="Windows-1251" ?&gt;
&lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
&lt;xsl:decimal-format decimal-separator=","/&gt;
	&lt;xsl:template match="/"&gt;
		&lt;HTML&gt;
			&lt;STYLE TYPE="text/css"&gt;
				.UFR {font-size: smaller; font-style: italic; color: sandybrown}
				.InRest {font-size: smaller; font-style: italic; color: green}
				.ConvCurr {font-size: smaller; font-style: normal; color: darkblue}
			&lt;/STYLE&gt;			
			&lt;BODY bgcolor="#FFFFFF"&gt;  

				&lt;P class="Caption"&gt;
					Ïðîòîêîë ïîïûòîê íåñàíêöèîíèðîâàííîãî äîñòóïà ñîòðóäíèêîâ ÕÊ "ÈÍÒÅÐÐÎÑ" â íåðåæèìíûå ïîìåùåíèÿ
					çà ïåðèîä ñ 
					&lt;font class="Param"&gt;
						#?pDateFrom?#
					&lt;/font&gt; äî
                    &lt;font class="Param"&gt;
						#?pDateTo?#
					&lt;/font&gt; (ãðóïèðîâêà ïî ïîìåùåíèÿì)
					&lt;TABLE width="50%"&gt;
					&lt;TR&gt;&lt;TD align="right"&gt;Îáúåêò:&lt;/TD&gt;&lt;TD&gt;#?pObjectName?#&lt;/TD&gt;&lt;/TR&gt;
					&lt;/TABLE&gt;
				&lt;/P&gt;
			
				&lt;TABLE id="myTab" width="100%" border="1" ID="GridTable" onclick="sortColumn(event)"&gt;
					&lt;TR style="display=table-header-group;" class="GridCaption" bgcolor="#FFFDE1"&gt;
						&lt;TD align="left"&gt;Ñîòðóäíèê&lt;/TD&gt;
						&lt;TD align="center"&gt;Íîìåð ïîïûòêè&lt;/TD&gt;
						&lt;TD align="center"&gt;Äàòà è âðåìÿ&lt;/TD&gt;
					&lt;/TR&gt;
					&lt;TBODY&gt;
					&lt;xsl:for-each select="//Query2Table[not(aDoor=preceding-sibling::Query2Table/aDoor)]"&gt;
						&lt;xsl:variable name="varFItem" select="aDoor[.]"/&gt;
						&lt;tr class="RowDIRECT"&gt;
							&lt;td class="UFR" colspan="3" align="center"&gt;&lt;xsl:value-of select="$varFItem" /&gt;&lt;/td&gt;
						&lt;/tr&gt;
						&lt;xsl:for-each select="//Query2Table[aDoor[.=$varFItem] and not(aUserName=preceding-sibling::Query2Table[aDoor[.=$varFItem]]/aUserName)]"&gt;
							&lt;xsl:variable name="varUser" select="aUserName[.]"/&gt;
							&lt;xsl:for-each select="//Query2Table[aDoor[.=$varFItem] and aUserName[.=$varUser]]"&gt;
								&lt;TR class="GridValue"&gt;
									&lt;xsl:choose&gt;
										&lt;xsl:when test="count(preceding-sibling::Query2Table[aDoor[.=$varFItem] and aUserName[.=$varUser]])=0"&gt;
											&lt;TD&gt;&lt;xsl:value-of select="$varUser" /&gt;&lt;/TD&gt;
										&lt;/xsl:when&gt;
										&lt;xsl:otherwise&gt;
											&lt;TD&gt;&lt;/TD&gt;
										&lt;/xsl:otherwise&gt;
									&lt;/xsl:choose&gt;
									&lt;TD align="center"&gt;&lt;xsl:value-of select="count(preceding-sibling::Query2Table[aDoor[.=$varFItem] and aUserName[.=$varUser]])+1" /&gt;&lt;/TD&gt;
									&lt;TD align="center"&gt;&lt;xsl:value-of select="aDateTime" /&gt;&lt;/TD&gt;
								&lt;/TR&gt;
							&lt;/xsl:for-each&gt;
						&lt;/xsl:for-each&gt;
					&lt;/xsl:for-each&gt;
					&lt;/TBODY&gt;
				&lt;/TABLE&gt;
			&lt;/BODY&gt;
		&lt;/HTML&gt;
	&lt;/xsl:template&gt;
&lt;/xsl:stylesheet&gt;
</XSLT>
      <ImageName />
      <Params>
        <Param>
          <Number>1</Number>
          <Title>Îáúåêò</Title>
          <Name>pObjectName</Name>
          <Type>String</Type>
          <Inset>true</Inset>
          <CurrentValue />
          <DefaultValue />
          <SelectValue />
        </Param>
        <Param>
          <Number>2</Number>
          <Title>Çà ïåðèîä ñ</Title>
          <Name>pDateFrom</Name>
          <Type>Date</Type>
          <Inset>false</Inset>
          <CurrentValue>01.05.2015</CurrentValue>
          <DefaultValue />
          <SelectValue />
        </Param>
        <Param>
          <Number>3</Number>
          <Title>ïî</Title>
          <Name>pDateTo</Name>
          <Type>Date</Type>
          <Inset>false</Inset>
          <CurrentValue>03.06.2015</CurrentValue>
          <DefaultValue />
          <SelectValue />
        </Param>
      </Params>
    </Query>
    <Query>
      <Code>0</Code>
      <Name>Áàëëàíñ ðàáî÷åãî âðåìåíè\Íåñàíêöèîíèðîâàííûé äîñòóï (ãðóïïèðîâêà ïî ñîòðóäíèêàì)</Name>
      <DateCreate>2010-06-04T12:56:34.2764898+03:00</DateCreate>
      <DateLastModified>2015-07-24T00:00:00+03:00</DateLastModified>
      <Hidden>false</Hidden>
      <Author>M.Tor</Author>
      <Note />
      <Text>SET dateformat dmy

DECLARE @dtFrom datetime, @dtTo datetime
SET @dtFrom = CAST(CONVERT (varchar(16), #?pDateFrom?#, 104) as datetime)
SET @dtTo = DATEADD(d, 1, CAST(CONVERT (varchar(16), #?pDateTo?#, 104) as datetime))

SELECT 
	PTER.TERRA_NAME AS aDoor
	,PP.LAST_NAME+' '+PP.FIRST_NAME+' '+PP.MIDDLE_NAME AS aUserName
	,CONVERT(varchar(50), DATEADD(hour, 3, PTTL.TRAN_DATE), 120) AS aDateTime
	,PTD.TRANTYPE_DESC AS TranDesc

FROM 
	[Parsec3Trans].dbo.[TransLog] AS PTTL
		INNER JOIN [Parsec3].dbo.[Person] AS PP ON PTTL.USR_ID=PP.PERS_ID
		INNER JOIN [Parsec3].[dbo].[TRANTYPES_DESC] AS PTD 
			ON PTTL.TRANTYPE_ID = PTD.TRANTYPE_ID
			AND PTD.LOCALE = 'RU'
		INNER JOIN [Parsec3].[dbo].[TRANTYPES] AS PTT
			ON PTTL.TRANTYPE_ID = PTT.TRANTYPE_ID
		INNER JOIN [Parsec3].[dbo].[TERRITORY] AS PTER
			ON PTTL.COMP_ID = PTER.ITEM_ID

WHERE
	DATEADD(hour, 3, PTTL.TRAN_DATE) &gt;= @dtFrom
	AND DATEADD(hour, 3, PTTL.TRAN_DATE) &lt; @dtTo
	AND PTTL.TRANTYPE_ID != 590113 -- ÐÐµÑ Ð´Ð¾ÑÑÑÐ¿Ð° Ð¿Ð¾ Ð±Ð»Ð¾ÐºÐ¸ÑÐ¾Ð²ÐºÐµ
	AND PTT.[TRANCLASS_MASK] &lt; 129
ORDER BY aUserName,aDoor,aDateTime
</Text>
      <XSLT>&lt;?xml version="1.0" encoding="Windows-1251" ?&gt;
&lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
&lt;xsl:decimal-format decimal-separator=","/&gt;
	&lt;xsl:template match="/"&gt;
		&lt;HTML&gt;
			&lt;STYLE TYPE="text/css"&gt;
				.UFR {font-size: smaller; font-style: italic; color: darkblue}
				.InRest {font-size: smaller; font-style: italic; color: green}
				.ConvCurr {font-size: smaller; font-style: normal; color: darkblue}
			&lt;/STYLE&gt;			
			&lt;BODY bgcolor="#FFFFFF"&gt;  

				&lt;P class="Caption"&gt;
					Ïðîòîêîë ïîïûòîê íåñàíêöèîíèðîâàííîãî äîñòóïà ñîòðóäíèêîâ ÕÊ "ÈÍÒÅÐÐÎÑ" â íåðåæèìíûå ïîìåùåíèÿ
					çà ïåðèîä ñ 
					&lt;font class="Param"&gt;
						#?pDateFrom?#
					&lt;/font&gt; äî
                    &lt;font class="Param"&gt;
						#?pDateTo?#
					&lt;/font&gt;	(ãðóïèðîâêà ïî ñîòðóäíèêàì)
					&lt;TABLE width="50%"&gt;
					&lt;TR&gt;&lt;TD align="right"&gt;Îáúåêò:&lt;/TD&gt;&lt;TD&gt;#?pObjectName?#&lt;/TD&gt;&lt;/TR&gt;
					&lt;/TABLE&gt;
				&lt;/P&gt;
			
				&lt;TABLE id="myTab" width="100%" border="1" ID="GridTable" onclick="sortColumn(event)"&gt;
					&lt;TR style="display=table-header-group;" class="GridCaption" bgcolor="#FFFDE1"&gt;
						&lt;TD align="left"&gt;Ïîìåùåíèå&lt;/TD&gt;
						&lt;TD align="center"&gt;Íîìåð ïîïûòêè&lt;/TD&gt;
						&lt;TD align="center"&gt;Äàòà è âðåìÿ&lt;/TD&gt;
					&lt;/TR&gt;
					&lt;TBODY&gt;
					&lt;xsl:for-each select="//Query2Table[not(aUserName=preceding-sibling::Query2Table/aUserName)]"&gt;
						&lt;xsl:variable name="varUserName" select="aUserName[.]"/&gt;
						&lt;tr class="RowDIRECT"&gt;
							&lt;td class="UFR" colspan="3" align="center"&gt;&lt;xsl:value-of select="$varUserName" /&gt;&lt;/td&gt;
						&lt;/tr&gt;
						&lt;xsl:for-each select="//Query2Table[aUserName[.=$varUserName] and not(aDoor=preceding-sibling::Query2Table[aUserName[.=$varUserName]]/aDoor)]"&gt;
							&lt;xsl:variable name="varDoor" select="aDoor[.]"/&gt;
							&lt;xsl:for-each select="//Query2Table[aUserName[.=$varUserName] and aDoor[.=$varDoor]]"&gt;
								&lt;TR class="GridValue"&gt;
									&lt;xsl:choose&gt;
										&lt;xsl:when test="count(preceding-sibling::Query2Table[aUserName[.=$varUserName] and aDoor[.=$varDoor]])=0"&gt;
											&lt;TD&gt;&lt;xsl:value-of select="$varDoor" /&gt;&lt;/TD&gt;
										&lt;/xsl:when&gt;
										&lt;xsl:otherwise&gt;
											&lt;TD&gt;&lt;/TD&gt;
										&lt;/xsl:otherwise&gt;
									&lt;/xsl:choose&gt;
									&lt;TD align="center"&gt;&lt;xsl:value-of select="count(preceding-sibling::Query2Table[aUserName[.=$varUserName] and aDoor[.=$varDoor]])+1" /&gt;&lt;/TD&gt;
									&lt;TD align="center"&gt;&lt;xsl:value-of select="aDateTime" /&gt;&lt;/TD&gt;
								&lt;/TR&gt;
							&lt;/xsl:for-each&gt;
						&lt;/xsl:for-each&gt;
					&lt;/xsl:for-each&gt;
					&lt;/TBODY&gt;
				&lt;/TABLE&gt;
			&lt;/BODY&gt;
		&lt;/HTML&gt;
	&lt;/xsl:template&gt;
&lt;/xsl:stylesheet&gt;
</XSLT>
      <ImageName />
      <Params>
        <Param>
          <Number>1</Number>
          <Title>Îáúåêò</Title>
          <Name>pObjectName</Name>
          <Type>String</Type>
          <Inset>true</Inset>
          <CurrentValue />
          <DefaultValue />
          <SelectValue />
        </Param>
        <Param>
          <Number>2</Number>
          <Title>Çà ïåðèîä ñ</Title>
          <Name>pDateFrom</Name>
          <Type>Date</Type>
          <Inset>false</Inset>
          <CurrentValue>01.05.2015</CurrentValue>
          <DefaultValue />
          <SelectValue />
        </Param>
        <Param>
          <Number>3</Number>
          <Title>ïî</Title>
          <Name>pDateTo</Name>
          <Type>Date</Type>
          <Inset>false</Inset>
          <CurrentValue>03.06.2015</CurrentValue>
          <DefaultValue />
          <SelectValue />
        </Param>
      </Params>
    </Query>
    <Query>
      <Code>0</Code>
      <Name>Áàëëàíñ ðàáî÷åãî âðåìåíè\Ñîòðóäíèêè íà îáúåêòå</Name>
      <DateCreate>2010-06-02T12:46:20.8646032+03:00</DateCreate>
      <DateLastModified>2015-09-08T00:00:00+03:00</DateLastModified>
      <Hidden>true</Hidden>
      <Author>M.Tor</Author>
      <Note />
      <Text>
SET dateformat dmy


--DECLARE  @TInOut table 
--	(aDate varchar(20), aTimeIn datetime, aTimeOut datetime, aUserID int, aUser varchar(255))
	
--INSERT @TInOut
SELECT
	CONVERT(varchar(20), TrLog.aDT, 120) AS aDate_Time
--	,TransLog.TranDesc AS aTrDescLog
--	,TransDesc.TranDesc AS aTrDesc
	,CASE 
		WHEN TransLog.TranCode = 64 THEN 'äà' 
		ELSE 'íåò'
	 END AS  aIsWithin
--	,TransLog.TranUser AS aUser
	,Personel.FirstName 
	 + ' ' + Personel.SecondName
	 + ' ' + Personel.ThirdName AS aUserName
	,TransLog.TranArea AS aDoor
	,Doors.AreaName AS aDoor2
--	,CONVERT(varchar(32), TrLog.aDT, 121), aUserID
FROM 
	(SELECT	MAX(TranDateTime) AS aDT, TranUserID AS aUserID
	FROM TransLog 
	WHERE CAST(CONVERT(varchar(16), TranDateTime, 104) as datetime) = CAST(CONVERT(varchar(16), GETDATE(), 104) as datetime)
		AND TransLog.TranCode IN (64, 65)
	GROUP BY TranUserID) AS TrLog
		INNER JOIN TransLog ON TransLog.TranDateTime=TrLog.aDT AND TransLog.TranUserID=TrLog.aUserID
		INNER JOIN Personel ON TransLog.TranUserID=Personel.ID_USER
--		INNER JOIN TransDesc ON TransLog.TranCode=TransDesc.TranCode
		INNER JOIN Doors ON TransLog.TranCtrlID=Doors.ID_DOOR
WHERE
	LEN(Personel.FirstName + Personel.SecondName + Personel.ThirdName) &gt; 0
	#?pFltWhere?#
ORDER BY 3

SELECT CONVERT(varchar(20), GETDATE(), 120) AS aToday

SELECT
	CASE 
		WHEN PATINDEX ('%64%', '#?pFltWhere?#') &gt; 0 THEN 1
		WHEN PATINDEX ('%65%', '#?pFltWhere?#') &gt; 0 THEN 2
		ELSE 0
	END AS aFltCode
	,CASE 
		WHEN PATINDEX ('%64%', '#?pFltWhere?#') &gt; 0 THEN 'ñîòðóäíèêè íà îáúåêòå'
		WHEN PATINDEX ('%65%', '#?pFltWhere?#') &gt; 0 THEN 'ñîòðóäíèêè âíå îáúåêòà'
		ELSE 'âñå ñîòðóäíèêè'
	END AS aFltText

</Text>
      <XSLT>&lt;?xml version="1.0" encoding="Windows-1251" ?&gt;
&lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
&lt;xsl:output method="xml" version="1.0" encoding="windows-1251" indent="yes"/&gt;
	&lt;xsl:template match="/Query2DS"&gt;
		&lt;HTML&gt;
			&lt;HEAD&gt;
				&lt;TITLE&gt;Ñîòðóäíèêè íà/âíå îáúåêò(å/à)&lt;/TITLE&gt;
			&lt;/HEAD&gt;         

			&lt;STYLE TYPE="text/css"&gt;
				.Param {font-size: smaller; font-style: normal; color: darkblue}
			&lt;/STYLE&gt;			
            
			&lt;BODY bgcolor="#FFFFFF"&gt;
				&lt;P class="Caption"&gt;
					Ïðåäïîëàãàåìîå íàõîæäåíèå ñîòðóäíèêà íà/âíå îáúåêò(å/à). 
					&lt;BR/&gt;Âðåìÿ : 
					&lt;font class="Param"&gt;
						&lt;xsl:value-of select="Query2Table2/aToday" /&gt;
					&lt;/font&gt;
					&lt;BR/&gt;Ôèëüòð: &lt;font class="Param"&gt;&lt;xsl:value-of select="Query2Table3/aFltText" /&gt;&lt;/font&gt;
				&lt;/P&gt;
				
				&lt;TABLE width="100%" border="1" ID="GridTable" onclick="sortColumn(event)"&gt;
					&lt;!-- ÷òîáû øàïêà òàáëèöû ïîÿâëÿëàñü íà êàæäîé ñòðàíèöå ïðè ïå÷àòè --&gt;
					&lt;THEAD class="GridCaption"&gt;                     
						&lt;TR&gt;
							&lt;TD align="center" width="3%"&gt;¹&lt;/TD&gt;
							&lt;TD align="left" width="40%"&gt;Ô.È.Î. Ñîòðóäíèêà&lt;/TD&gt;
							&lt;xsl:if test="Query2Table3/aFltCode[.]=0"&gt;
								&lt;TD align="center" width="7%"&gt;Íàõîäèòñÿ íà îáúåêòå&lt;/TD&gt;
							&lt;/xsl:if&gt;
                            &lt;TD align="left" width="20%"&gt;Âðåìÿ ïîñëåäíåé ôèêñàöèè&lt;/TD&gt;
							&lt;TD align="left" width="30%"&gt;Ìåñòî ïîñëåäíåé ôèêñàöèè&lt;/TD&gt;
						&lt;/TR&gt;
					&lt;/THEAD&gt;
					&lt;TBODY id="TBody"&gt;
						&lt;xsl:for-each select="Query2Table"&gt;
                            &lt;xsl:comment&gt;comments&lt;/xsl:comment&gt;
							&lt;TR class="GridValue"&gt;
								&lt;TD&gt;&lt;xsl:number/&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aUserName" /&gt;&lt;/TD&gt;
								&lt;xsl:if test="../Query2Table3/aFltCode[.]=0"&gt;
									&lt;TD&gt;&lt;xsl:value-of select="aIsWithin" /&gt;&lt;/TD&gt;
								&lt;/xsl:if&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aDate_Time" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aDoor" /&gt;&lt;/TD&gt;
							&lt;/TR&gt;
						&lt;/xsl:for-each&gt;                        
					&lt;/TBODY&gt;
				&lt;/TABLE&gt;
			&lt;/BODY&gt;
		&lt;/HTML&gt;
	&lt;/xsl:template&gt;
&lt;/xsl:stylesheet&gt;
</XSLT>
      <ImageName />
      <Params>
        <Param>
          <Number>5</Number>
          <Title>Ôèëüòð</Title>
          <Name>pFltWhere</Name>
          <Type>StrSelectList</Type>
          <Inset>true</Inset>
          <CurrentValue>:âñå ñîòðóäíèêè</CurrentValue>
          <DefaultValue />
          <SelectValue>~âñå ñîòðóäíèêè
 AND TransLog.TranCode = 64~ñîòðóäíèêè íà îáúåêòå
 AND TransLog.TranCode = 65~ñîòðóäíèêè âíå îáúåêòà</SelectValue>
        </Param>
      </Params>
    </Query>
    <Query>
      <Code>0</Code>
      <Name>Çàïðîñ äëÿ ïðîãðàììû îòñëåæèâàíèÿ ââîäà èíèöèàòîðîâ</Name>
      <DateCreate>2015-08-26T15:51:49.8867187+03:00</DateCreate>
      <DateLastModified>2015-08-28T00:00:00+03:00</DateLastModified>
      <Hidden>false</Hidden>
      <Author>MaryM</Author>
      <Note />
      <Text>SET DATEFORMAT dmy

DECLARE @dtFrom datetime
SET @dtFrom = #?pDateFrom?#

-- Ôîðìèðóåì òàáëèöó çàÿâîê, îãðàíè÷åííûõ ïî ïàðàìåòðó äàòå
DECLARE @BPVISIT TABLE
(aDateReq datetime, aVisitor varchar(255), aVisitorID uniqueidentifier,  
aVisitInit varchar(255), aAdmitFromDate datetime, aAdmitToDate datetime, 
aRequestNum int, aStatusReq int, aStatusReqName varchar(255))
INSERT INTO @BPVISIT
SELECT
-- Äàòà çàêàçà
DATEADD(hour, 3, VR.REQUEST_DATE) as aDateReq, 
-- ÔÈÎ ïîñåòèòåëÿ
PV.LAST_NAME+' '+PV.FIRST_NAME+' '+PV.MIDDLE_NAME as aVisitor, 
-- ID ïîñåòèòåëÿ
VR.VISITOR_ID as aVisitorID, 
VR.VISIT_PURPOSE as aVisitInit,  
-- Äàòà íà÷àëà äåéñòâèÿ çàÿâêè
-- íà÷àëî äíÿ
CAST(CONVERT(varchar(10), VR.ADMIT_START, 104) as datetime) as aAdmitFromDate, 
--DATEADD(hour, 3, VR.ADMIT_START) as aAdmitFromDate, 
-- Äàòà îêîí÷àíèÿ äåéñòâèÿ çàÿâêè
DATEADD(hour, 3, VR.ADMIT_END) as aAdmitToDate, 
VR.REQUEST_NUM as aRequestNum, 
-- Ñòàòóñ çàÿâêè
-- 0 - Îæèäàíèå ñîãëàñîâàíèÿ
-- 1 - Ñîãëàñîâàíâ
-- 2 - Îòêëîíåíà
-- 3 - Âûäàí ïðîïóñê
-- 4 - Çàêðûòà
VR.REQUEST_STATUS as aStatusReq, 
CASE WHEN VR.REQUEST_STATUS = 0 THEN 'îæèäàíèå ñîãëàñîâàíèÿ'
		WHEN VR.REQUEST_STATUS = 1 THEN 'ñîãëàñîâàíà'
			WHEN VR.REQUEST_STATUS = 2 THEN 'îòêëîíåíà'
				WHEN VR.REQUEST_STATUS = 3 THEN 'âûäàí ïðîïóñê'
					WHEN VR.REQUEST_STATUS = 4 THEN 'çàêðûòà'
ELSE '' END as aStatusReqName

FROM 
[Parsec3].dbo.[VISITOR_REQUEST] as VR
	INNER JOIN [Parsec3].dbo.[Person] as PV ON PV.PERS_ID = VR.VISITOR_ID

WHERE
@dtFrom &lt;= CAST(CONVERT(varchar(10), DATEADD(hour, 3, VR.ADMIT_START), 104) as datetime) 

--- âûäàåì ñòðîêè, â êîòîðûõ íå âñòðå÷àåòñÿ íàøèõ èñêîìûõ ñëîâ
DECLARE @TT TABLE
(aDateReq datetime, aVisitor varchar(255), aVisitorID uniqueidentifier,  
aVisitInit varchar(255), aAdmitFromDate datetime, aAdmitToDate datetime, 
aRequestNum int, aStatusReq int, aStatusReqName varchar(255))

INSERT INTO @TT
SELECT aDateReq, aVisitor, aVisitorID, aVisitInit, aAdmitFromDate, aAdmitToDate, aRequestNum, aStatusReq, aStatusReqName
FROM @BPVISIT
WHERE
LEN(ISNULL(aVisitInit, '')) = 0
OR
(ISNULL(aVisitInit, '') NOT LIKE 
			(CASE WHEN LEN('#?pStr1?#') &gt; 0 THEN '%#?pStr1?#%'
					ELSE ''
						END)
AND ISNULL(aVisitInit, '') NOT LIKE 
			(CASE WHEN LEN('#?pStr2?#') &gt; 0 THEN '%#?pStr2?#%'
					ELSE ''
						END)
AND ISNULL(aVisitInit, '') NOT LIKE 
			(CASE WHEN LEN('#?pStr3?#') &gt; 0 THEN '%#?pStr3?#%'
					ELSE ''
						END)
AND ISNULL(aVisitInit, '') NOT LIKE
			(CASE WHEN LEN('#?pStr4?#') &gt; 0 THEN '%#?pStr4?#%'
					ELSE ''
						END)
)

SELECT 
'Çàÿâêà ¹ ' + CAST(aRequestNum as varchar(255)) + ' [' + aVisitor + '] íå ñîäåðæèò êëþ÷åâûõ ñëîâ'
FROM @TT
ORDER BY aDateReq ASC
</Text>
      <XSLT />
      <ImageName />
      <Params>
        <Param>
          <Number>1</Number>
          <Title>Äàòà ñ:</Title>
          <Name>pDateFrom</Name>
          <Type>Date</Type>
          <Inset>false</Inset>
          <CurrentValue>03.08.2015</CurrentValue>
          <DefaultValue />
          <SelectValue />
        </Param>
        <Param>
          <Number>2</Number>
          <Title>Ñòðîêà1</Title>
          <Name>pStr1</Name>
          <Type>String</Type>
          <Inset>true</Inset>
          <CurrentValue>ìî</CurrentValue>
          <DefaultValue />
          <SelectValue />
        </Param>
        <Param>
          <Number>3</Number>
          <Title>Ñòðîêà2</Title>
          <Name>pStr2</Name>
          <Type>String</Type>
          <Inset>true</Inset>
          <CurrentValue />
          <DefaultValue />
          <SelectValue />
        </Param>
        <Param>
          <Number>4</Number>
          <Title>Ñòðîêà3</Title>
          <Name>pStr3</Name>
          <Type>String</Type>
          <Inset>true</Inset>
          <CurrentValue />
          <DefaultValue />
          <SelectValue />
        </Param>
        <Param>
          <Number>5</Number>
          <Title>Ñòðîêà4</Title>
          <Name>pStr4</Name>
          <Type>String</Type>
          <Inset>true</Inset>
          <CurrentValue />
          <DefaultValue />
          <SelectValue />
        </Param>
      </Params>
    </Query>
    <Query>
      <Code>0</Code>
      <Name>Îò÷åò î ïîñåòèòåëÿõ çà ïåðèîä (èíèöèàòîð - êàðòà)</Name>
      <DateCreate>2015-07-22T16:16:15.234375+03:00</DateCreate>
      <DateLastModified>2015-09-08T00:00:00+03:00</DateLastModified>
      <Hidden>false</Hidden>
      <Author>MaryM</Author>
      <Note />
      <Text>SET DATEFORMAT dmy

DECLARE @dtMin datetime
DECLARE @dtMax datetime
SET @dtMin = '01.01.1900'
SET @dtMax = '01.01.2100'

DECLARE @dtFrom datetime
DECLARE @dtTo datetime
SET @dtFrom = #?pDateFrom?#
SET @dtTo = #?pDateTo?#
--SET @dtFrom = '05.08.2015'
--SET @dtTo = '05.08.2015'

---Ñ÷èòûâàåì äîêóìåíò
-- Òèï äîêóìåíòà
DECLARE @DOCT TABLE(aPers uniqueidentifier, aDocType varchar(255))
INSERT INTO @DOCT	
	SELECT  VV.PERS_ID, CAST(VV.EXTRA_FIELD_VALUE as varchar(255))
	FROM
		EXTRA_FIELD_VALUE AS VV 
			INNER JOIN EXTRA_FIELD_TEMPLATE AS TT ON TT.FIELD_TEMPLATE_ID = VV.FIELD_TEMPLATE_ID 
												AND TT.FIELD_TEMPLATE_NAME = 'Òèï äîêóìåíòà'
-- Ñåðèÿ äîêóìåíòà
DECLARE @DOCS TABLE(aPers uniqueidentifier, aDocSer varchar(255))
INSERT INTO @DOCS	
	SELECT  VV.PERS_ID, CAST(VV.EXTRA_FIELD_VALUE as varchar(255))
	FROM
		EXTRA_FIELD_VALUE AS VV 
			INNER JOIN EXTRA_FIELD_TEMPLATE AS TT ON TT.FIELD_TEMPLATE_ID = VV.FIELD_TEMPLATE_ID 
												AND TT.FIELD_TEMPLATE_NAME = 'Ñåðèÿ äîêóìåíòà'					 
-- Íîìåð äîêóìåíòà
DECLARE @DOCN TABLE(aPers uniqueidentifier, aDocNumber varchar(255))
INSERT INTO @DOCN	
	SELECT  VV.PERS_ID, CAST(VV.EXTRA_FIELD_VALUE as varchar(255))
	FROM
		EXTRA_FIELD_VALUE AS VV 
			INNER JOIN EXTRA_FIELD_TEMPLATE AS TT ON TT.FIELD_TEMPLATE_ID = VV.FIELD_TEMPLATE_ID 
												AND TT.FIELD_TEMPLATE_NAME = 'Íîìåð äîêóìåíòà'	
-- Êåì âûäàí äîêóìåíò
DECLARE @DOCV TABLE(aPers uniqueidentifier, aDocMil varchar(255))												
INSERT INTO @DOCV	
	SELECT  VV.PERS_ID, CAST(VV.EXTRA_FIELD_VALUE as varchar(255))
	FROM
		EXTRA_FIELD_VALUE AS VV 
			INNER JOIN EXTRA_FIELD_TEMPLATE AS TT ON TT.FIELD_TEMPLATE_ID = VV.FIELD_TEMPLATE_ID 
												AND TT.FIELD_TEMPLATE_NAME = 'Êåì âûäàí äîêóìåíò'
-- Äàòà âûäà÷è
DECLARE @DOCD TABLE(aPers uniqueidentifier, aDocDate varchar(255))												
INSERT INTO @DOCD	
	SELECT  VV.PERS_ID, CAST(VV.EXTRA_FIELD_VALUE as varchar(255))
	FROM
		EXTRA_FIELD_VALUE AS VV 
			INNER JOIN EXTRA_FIELD_TEMPLATE AS TT ON TT.FIELD_TEMPLATE_ID = VV.FIELD_TEMPLATE_ID 
												AND TT.FIELD_TEMPLATE_NAME = 'Äàòà âûäà÷è äîêóìåíòà'	
												
-- ÇÀßÂÊÈ ÏÎÑÅÒÈÒÅËÅÉ Â ÁÞÐÎ ÏÐÎÏÓÑÊÎÂ												
DECLARE @BPVISIT TABLE
(aDateReq datetime, aVisitor varchar(255), aVisitorID uniqueidentifier, aVisitToWho varchar(255),  
aVisitInitID uniqueidentifier, aTypeDoc varchar(255), aDoc varchar(255), aOperator varchar(255), aAdmitFromDate datetime, aAdmitToDate datetime, 
aRequestNum int, aStatusReq int, aStatusReqName varchar(255), aRevisor varchar(255), aActivator varchar(255))
INSERT INTO @BPVISIT
SELECT
-- Äàòà çàêàçà
DATEADD(hour, 3, VR.REQUEST_DATE) as aDateReq, 
-- ÔÈÎ ïîñåòèòåëÿ
PV.LAST_NAME+' '+PV.FIRST_NAME+' '+PV.MIDDLE_NAME as aVisitor, 
-- ID ïîñåòèòåëÿ
VR.VISITOR_ID as aVisitorID, 
-- Ê êîìó
Dep.aDepName as aVisitToWho,  
-- Èíèöèàòîð çàÿâêè
-- Çäåñü âûáèðàåì èç òàá. TRANSLOG USR_ID òîãî èäåíòèôèêàòîðà, êîòîðîãî ïðèëîæèëè ê êîíêðåòíîìó ñ÷èòûâàòåëþ
-- Ñàìîå ïåðâîå ïîñëå ñîçäàíèÿ êîíêðåòíîé çàÿâêè 
-- Ýòî ìîæåò áûòü ëþáîå ñîáûòèå, ìû çäåñü íå îãðàíè÷èâàåì ïî òèïó
-- Äëÿ ýòîãî îáÿçàòåëüíî äîëæíà áûòü âûäåðæàíà ïîñëåäîâàòåëüíîñòü äåéñòâèé îïåðàòîðà
-- Ñîçäàíèå çàÿâêè, ðåâèçèÿ (ñîãëàñîâàíèå), à óæ ïîòîì âñå äåéñòâèé ñ äðóãîé çàÿâêîé
(SELECT TOP 1 [USR_ID]
	 FROM [Parsec3Trans].[dbo].[TRANSLOG]
	 WHERE 
		DATEADD(hour, 3, [TRAN_DATE]) &gt; DATEADD(hour, 3, VR.REQUEST_DATE)
	   AND [COMP_ID] = '80015421-ec02-49bc-b41c-f0ceaf798e3c'  
	 ORDER BY [TRAN_DATE] ASC
	) as aVisitInitID, 
-- Äîêóìåíò
ISNULL(DT.aDocType, '') as aTypeDoc, 
ISNULL(' ' + DS.aDocSer, '') 
+ ISNULL(' ' + DN.aDocNumber, '')
+ ISNULL(' âûäàí ' + DV.aDocMil, '')  
+ ISNULL(' ' + DD.aDocDate + ' ã.', '') as aDoc, 
-- Îïåðàòîð
DMO.FULLNAME as aOperator, 
-- Äàòà íà÷àëà äåéñòâèÿ çàÿâêè
-- íà÷àëî äíÿ
CAST(CONVERT(varchar(10), VR.ADMIT_START, 104) as datetime) as aAdmitFromDate, 
--DATEADD(hour, 3, VR.ADMIT_START) as aAdmitFromDate, 
-- Äàòà îêîí÷àíèÿ äåéñòâèÿ çàÿâêè
DATEADD(hour, 3, VR.ADMIT_END) as aAdmitToDate, 
VR.REQUEST_NUM as aRequestNum, 
-- Ñòàòóñ çàÿâêè
-- 0 - Îæèäàíèå ñîãëàñîâàíèÿ
-- 1 - Ñîãëàñîâàíâ
-- 2 - Îòêëîíåíà
-- 3 - Âûäàí ïðîïóñê
-- 4 - Çàêðûòà
VR.REQUEST_STATUS as aStatusReq, 
CASE WHEN VR.REQUEST_STATUS = 0 THEN 'îæèäàíèå ñîãëàñîâàíèÿ'
		WHEN VR.REQUEST_STATUS = 1 THEN 'ñîãëàñîâàíà'
			WHEN VR.REQUEST_STATUS = 2 THEN 'îòêëîíåíà'
				WHEN VR.REQUEST_STATUS = 3 THEN 'âûäàí ïðîïóñê'
					WHEN VR.REQUEST_STATUS = 4 THEN 'çàêðûòà'
ELSE '' END as aStatusReqName, 
-- Ðåâèçîð çàÿâêè
DMR.FULLNAME as aRevisor, 
-- Àêòèâàòîð çàÿâêè
DMA.FULLNAME as aActivator


FROM 
[Parsec3].dbo.[VISITOR_REQUEST] as VR
	LEFT JOIN [Parsec3].dbo.[PERSON] as PV ON VR.VISITOR_ID = PV.PERS_ID
	LEFT JOIN [Parsec3].dbo.[DOMAIN_MEMBERSHIP] as DMR ON VR.REVISOR_ID = DMR.M_ID
	LEFT JOIN [Parsec3].dbo.[DOMAIN_MEMBERSHIP] as DMO ON VR.OPERATOR_ID = DMO.M_ID
	LEFT JOIN [Parsec3].dbo.[DOMAIN_MEMBERSHIP] as DMA ON VR.ACTIVATOR_ID = DMA.M_ID
	LEFT JOIN @DOCT as DT ON DT.aPers = VR.VISITOR_ID
	LEFT JOIN @DOCS as DS ON DS.aPers = VR.VISITOR_ID
	LEFT JOIN @DOCN as DN ON DN.aPers = VR.VISITOR_ID
	LEFT JOIN @DOCV as DV ON DV.aPers = VR.VISITOR_ID 
	LEFT JOIN @DOCD as DD ON DD.aPers = VR.VISITOR_ID 
	INNER JOIN
			(
			SELECT D1.ORG_ID AS DD, D1.ORG_NAME as aDepName 
				FROM [Parsec3].[dbo].[ORGANIZATION] AS D1 
					#?pDep?#
			UNION
			SELECT D2.ORG_ID AS DD, D2.ORG_NAME as aDepName 
				FROM [Parsec3].[dbo].[ORGANIZATION] AS D1 
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D2 ON D1.ORG_ID=D2.PARENT_ID
					#?pDep?#
			UNION
			SELECT D3.ORG_ID AS DD, D3.ORG_NAME as aDepName
				FROM [Parsec3].[dbo].[ORGANIZATION] AS D1 
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D2 ON D1.ORG_ID=D2.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D3 ON D2.ORG_ID=D3.PARENT_ID
					#?pDep?#
			UNION
			SELECT D4.ORG_ID AS DD, D4.ORG_NAME as aDepName 
				FROM [Parsec3].[dbo].[ORGANIZATION] AS D1 
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D2 ON D1.ORG_ID=D2.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D3 ON D2.ORG_ID=D3.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D4 ON D3.ORG_ID=D4.PARENT_ID
					#?pDep?#
			UNION
			SELECT D5.ORG_ID AS DD, D5.ORG_NAME as aDepName 
				FROM [Parsec3].[dbo].[ORGANIZATION] AS D1 
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D2 ON D1.ORG_ID=D2.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D3 ON D2.ORG_ID=D3.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D4 ON D3.ORG_ID=D4.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D5 ON D4.ORG_ID=D5.PARENT_ID
					#?pDep?#
			UNION
			SELECT D6.ORG_ID AS DD, D6.ORG_NAME as aDepName 
				FROM [Parsec3].[dbo].[ORGANIZATION] AS D1 
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D2 ON D1.ORG_ID=D2.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D3 ON D2.ORG_ID=D3.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D4 ON D3.ORG_ID=D4.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D5 ON D4.ORG_ID=D5.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D6 ON D5.ORG_ID=D6.PARENT_ID
					#?pDep?#
			UNION
			SELECT D7.ORG_ID AS DD, D7.ORG_NAME as aDepName 
				FROM [Parsec3].[dbo].[ORGANIZATION] AS D1 
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D2 ON D1.ORG_ID=D2.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D3 ON D2.ORG_ID=D3.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D4 ON D3.ORG_ID=D4.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D5 ON D4.ORG_ID=D5.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D6 ON D5.ORG_ID=D6.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D7 ON D6.ORG_ID=D7.PARENT_ID
					#?pDep?#
		) AS DEP ON VR.OWNER_ID = DEP.DD
WHERE
@dtFrom &lt;= CAST(CONVERT(varchar(10), DATEADD(hour, 3, VR.ADMIT_END), 104) as datetime) AND
@dtTo &gt;= CAST(CONVERT(varchar(10), DATEADD(hour, 3, VR.ADMIT_START), 104) as datetime) AND
ISNULL(PV.LAST_NAME+' '+PV.FIRST_NAME+' '+PV.MIDDLE_NAME, '') LIKE '%#?pPerson?#%'


--1
--SELECT * FROM @BPVISIT ORDER BY aDateReq, aVisitor

-- ÏÐÎÕÎÄÛ (ÒÐÀÍÇÀÊÖÈÈ) ñ òèïîì ÍÎÐÌÀËÜÍÛÉ ÂÕÎÄ ÏÎ ÊËÞ×Ó è ÍÎÐÌÀËÜÍÛÉ ÂÛÕÎÄ ÏÎ ÊËÞ×Ó
DECLARE @TINOUT TABLE(aID int, aMask int, 
					aTranTypeID int, 
					aTranDescription varchar(255), 
					aPersID uniqueidentifier, 
					aTranDate datetime,  
					aComp varchar(255))
INSERT INTO @TINOUT						
SELECT
PTTL.rid as aID, 
PTT.TRANCLASS_MASK as aMask, 
PTTL.TRANTYPE_ID as aTranTypeID, 
PTD.TRANTYPE_DESC as aTranDescription, 
PTTL.USR_ID as aPersID, 
DATEADD(hour, 3, PTTL.TRAN_DATE) as aTranDate, 
PTER.TERRA_NAME as aComp
FROM 
	[Parsec3Trans].dbo.[TransLog] AS PTTL
		INNER JOIN [Parsec3].[dbo].[TRANTYPES_DESC] AS PTD 
			ON PTTL.TRANTYPE_ID = PTD.TRANTYPE_ID
			AND PTD.LOCALE = 'RU'
		INNER JOIN [Parsec3].[dbo].[TRANTYPES] AS PTT
			ON PTTL.TRANTYPE_ID = PTT.TRANTYPE_ID
		INNER JOIN [Parsec3].[dbo].[TERRITORY] AS PTER
			ON PTTL.COMP_ID = PTER.ITEM_ID

WHERE
	DATEADD(hour, 3, PTTL.TRAN_DATE) &gt;= @dtFrom
	AND DATEADD(hour, 3, PTTL.TRAN_DATE) &lt; DATEADD(day, 1, @dtTo)
	AND PTTL.TRANTYPE_ID IN(590144, 590145)					

--2
--SELECT * FROM @TINOUT ORDER BY 5 DESC

-- Ðàñøíóðóåì òàáëè÷êó ïðîõîäîâ íà âõîäû è âûõîäû
DECLARE @TINOUT2 TABLE(
					aID int, 
					aPersID uniqueidentifier, 
					aTranDateIn datetime,  
					aTranDateOut datetime
					)
INSERT INTO @TINOUT2						
SELECT
TT.aID as aID, 
TT.aPersID as aPersID, 
CASE WHEN TT.aTranTypeID = 590144 THEN TT.aTranDate
		ELSE NULL--@dtMin
			END as aTranDateIn, 
CASE WHEN TT.aTranTypeID = 590145 THEN TT.aTranDate
		ELSE NULL --@dtMax
			END as aTranDateOut
FROM 
	@TINOUT as TT
ORDER BY 1, 2, 3

--3
--SELECT * FROM @TINOUT2 ORDER BY 1, 2, 3

-- Ñãðóïïèðóåì ïî ïåðñîíå è äàòå	
DECLARE @TINOUT3 TABLE(aPersID uniqueidentifier, aDateIn datetime, aDateOut datetime)
INSERT INTO @TINOUT3
SELECT 
TT1.aPersID, 
ISNULL(MIN(TT1.aTranDateIn), @dtMin), 
ISNULL(MAX(TT2.aTranDateOut), @dtMax)
FROM 
@TINOUT2 as TT1
LEFT JOIN @TINOUT2 as TT2 ON TT1.aPersID = TT2.aPersID
							and TT1.aTranDateIn &lt; TT2.aTranDateOut 
													
WHERE 
NOT (TT1.aTranDateIn IS NULL AND TT2.aTranDateOut IS NULL)
GROUP BY 
TT1.aPersID

ORDER BY 1 DESC

--4
--SELECT * FROM @TINOUT3

--ÂÛÕÎÄÍÀß ÒÀÁËÈÖÀ
SELECT
CONVERT(varchar(10), BP.aDateReq, 104) + ' ' + CAST(DATEPART(hour, BP.aDateReq) as varchar(2)) + ':' 
				+ CASE 
					WHEN LEN(CAST(DATEPART(minute, BP.aDateReq) as varchar(2))) = 1 
						THEN '0' + CAST(DATEPART(minute, BP.aDateReq) as varchar(2))
					ELSE CAST(DATEPART(minute, BP.aDateReq) as varchar(2))
					END 
				+ ':' 
				+ CASE
					WHEN LEN(CAST(DATEPART(ss, BP.aDateReq) as varchar(2))) = 1
						THEN '0' + CAST(DATEPART(ss, BP.aDateReq) as varchar(2))
					ELSE CAST(DATEPART(ss, BP.aDateReq) as varchar(2))
					END 
				as aDateReq, 
TT.aPersID as aVisitorID, 
BP.aVisitor as aVisitor,
CASE WHEN TT.aDateIn = @dtMin THEN '' 
		ELSE
			CONVERT(varchar(10), TT.aDateIn, 104) + ' ' + CAST(DATEPART(hour, TT.aDateIn) as varchar(2)) + ':' 
				+ CASE 
					WHEN LEN(CAST(DATEPART(minute, TT.aDateIn) as varchar(2))) = 1 
						THEN '0' + CAST(DATEPART(minute, TT.aDateIn) as varchar(2))
					ELSE CAST(DATEPART(minute, TT.aDateIn) as varchar(2))
					END 
				+ ':' 
				+ CASE 
					WHEN LEN(CAST(DATEPART(ss, TT.aDateIn) as varchar(2))) = 1
						THEN '0' + CAST(DATEPART(ss, TT.aDateIn) as varchar(2))
					ELSE CAST(DATEPART(ss, TT.aDateIn) as varchar(2))
					END
		END as aIn, 
CASE WHEN TT.aDateOut = @dtMax THEN ''
		ELSE 
			CONVERT(varchar(10), TT.aDateOut, 104) + ' ' + CAST(DATEPART(hour, TT.aDateOut) as varchar(2)) + ':' 
				+ CASE 
					WHEN LEN(CAST(DATEPART(minute, TT.aDateOut) as varchar(2))) = 1 
						THEN '0' + CAST(DATEPART(minute, TT.aDateOut) as varchar(2))
					ELSE CAST(DATEPART(minute, TT.aDateOut) as varchar(2))
					END 
				+ ':' 
				+ CASE 
					WHEN LEN(CAST(DATEPART(ss, TT.aDateOut) as varchar(2))) = 1
						THEN '0' + CAST(DATEPART(ss, TT.aDateOut) as varchar(2))
					ELSE CAST(DATEPART(ss, TT.aDateOut) as varchar(2))
					END
		END as aOut, 
BP.aVisitToWho as aVisitToWho, 
BP.aOperator as aOperator, 
BP.aRequestNum as aRequestNum, 
-- èíèöèàòîð ïî âõîäó â ñèñòåìó îïåðàòîðà
--IR.FULLNAME as aVisitInit3,  
PP.LAST_NAME as aVisitInit, 
BP.aTypeDoc as aTypeDoc, 
BP.aDoc as aDoc

FROM
@TINOUT3 as TT
		INNER JOIN @BPVISIT AS BP ON TT.aPersID = BP.aVisitorID 
			-- îãðàíè÷åíèÿ ïî íà÷àëó è îêîí÷àíèþ äîñòóïà èç òàáëèöû ïî ïîñåòèòåëÿì
		AND TT.aDateIn &lt;= BP.aAdmitToDate AND TT.aDateOut &gt;= BP.aAdmitFromDate
		--AND BP.aStatusReq IN(3, 4)
		
		-- ñìûñë ýòî ñâÿçêè
		-- â ïîëå aVisitInitID çàïèñàí êîä èç òàáëèöû ïåðñîí, 
		-- êîòîðûé ïî ïðèâÿçàííîé êàðòå (îäèíàêîâîé!) ñâÿçûâàåì ñ òàá. DOMAIN_MEMBERSHIP
		LEFT JOIN [Parsec3].dbo.[PERSON] as PP
			ON PP.PERS_ID = BP.aVisitInitID
	--	LEFT JOIN [Parsec3].dbo.[IDENTIFIER] as ID ON PP.Pers_ID = ID.PERS_ID 	
	--	LEFT JOIN [Parsec3].dbo.[Domain_Membership] as DM ON ID.CODE = DM.CODE AND ID.PIN = DM.PIN	

--WHERE BP.aVisitInitID = '139c5390-6177-4035-9a9f-76ba5924ff5d'
#?pInit?#	

ORDER BY TT.aDateIn	


-- Âûõîäíàÿ òàáëèöà 2 Ê ÊÎÌÓ
SELECT TOP 1
	D1.ORG_NAME AS aDepName	
FROM
	(
		SELECT NEWID() AS ORG_ID, ' Â Ñ Å' AS ORG_NAME
		UNION ALL
		SELECT DD.ORG_ID AS ORG_ID, DD.ORG_NAME AS ORG_NAME
		FROM [Parsec3].[dbo].[ORGANIZATION] AS DD
		WHERE LEN(DD.ORG_NAME) &gt; 0
	) AS D1
#?pDep?#

-- Âûõîäíàÿ òàáëèöà 3 Èíèöèàòîð
SELECT TOP 1
	PP.LAST_NAME AS aInitName
FROM
	@BPVISIT as BP
		LEFT JOIN [Parsec3].dbo.[PERSON] as PP
			ON PP.PERS_ID = BP.aVisitInitID
#?pInit?#			

-- Âûõîäíàÿ òàáëèöà 4 Ïåðñîíà
SELECT TOP 1
	BP.aVisitor as aPersName
FROM @BPVISIT as BP
WHERE BP.aVisitor LIKE '%#?pPerson?#%'
		


</Text>
      <XSLT>&lt;?xml version="1.0" encoding="Windows-1251" ?&gt;
&lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
&lt;xsl:output method="xml" version="1.0" encoding="windows-1251" indent="yes"/&gt;
	&lt;xsl:template match="/Query2DS"&gt;
		&lt;HTML&gt;
			&lt;STYLE TYPE="text/css"&gt;
				.Caption{font-weight: bold; font-size: 16pt; text-align: center; color: #800040}
				.Param{font-weight: bold; font-size: 14pt; color: black}
			&lt;/STYLE&gt;
			
			&lt;HEAD&gt;
				&lt;TITLE&gt;Îò÷åò î ïîñåòèòåëÿõ çà ïåðèîä&lt;/TITLE&gt;
			&lt;/HEAD&gt;         
            
			&lt;BODY bgcolor="#FFFFFF"&gt;
				&lt;P class="Caption"&gt;
					Îò÷åò î ïîñåòèòåëÿõ îáúåêòà çà ïåðèîä 
					ñ #?pDateFrom?#ã. ïî #?pDateTo?#ã.
					&lt;TABLE width="50%"&gt;
					&lt;TR class="Param"&gt;&lt;TD align="left" width="20%"&gt;Ê êîìó:&lt;/TD&gt;&lt;TD align="left" width="80%"&gt;&lt;xsl:value-of select="Query2Table2/aDepName" /&gt;&lt;/TD&gt;&lt;/TR&gt;
					&lt;TR class="Param"&gt;&lt;TD align="left" width="20%"&gt;Èíèöèàòîð:&lt;/TD&gt;&lt;TD align="left" width="80%"&gt;&lt;xsl:value-of select="Query2Table3/aInitName" /&gt;&lt;/TD&gt;&lt;/TR&gt;
					&lt;TR class="Param"&gt;&lt;TD align="left" width="20%"&gt;Ïîñåòèòåëü:&lt;/TD&gt;&lt;TD align="left" width="80%"&gt; #?pPerson?# &lt;/TD&gt;&lt;/TR&gt;
					&lt;/TABLE&gt;
				&lt;/P&gt;
				
				&lt;TABLE width="100%" border="1" ID="GridTable" onclick="sortColumn(event)"&gt;
					&lt;!-- ÷òîáû øàïêà òàáëèöû ïîÿâëÿëàñü íà êàæäîé ñòðàíèöå ïðè ïå÷àòè --&gt;
					&lt;THEAD class="GridCaption"&gt;                     
						&lt;TR&gt;
							&lt;TD align="center" rowspan="2" width="3%"&gt;¹ ï/ï&lt;/TD&gt;
							&lt;TD align="center" rowspan="2" width="5%"&gt;Äàòà çàÿâêè&lt;/TD&gt;
							&lt;TD align="center" rowspan="2" width="15%"&gt;Ô.È.Î ïîñåòèòåëÿ&lt;/TD&gt;
							&lt;TD align="center" rowspan="2" width="3%"&gt;Ê êîìó&lt;/TD&gt;
                            &lt;TD align="center" colspan="2" width="10%"&gt;Ïðåäúÿâëåííûé äîêóìåíò&lt;/TD&gt;
							&lt;TD align="center" rowspan="2" width="10%"&gt;Èíèöèàòîð çàÿâêè&lt;/TD&gt;
							&lt;TD align="center" rowspan="2" width="10%"&gt;Çàÿâêó ââåë&lt;/TD&gt;
							&lt;TD align="center" rowspan="2" width="3%"&gt;Âûäàí ïðîïóñê ¹&lt;/TD&gt;
							&lt;TD align="center" rowspan="2" width="3%"&gt;Âðåìÿ âõ.&lt;/TD&gt;
							&lt;TD align="center" rowspan="2" width="3%"&gt;Âðåìÿ âûõ.&lt;/TD&gt;
						&lt;/TR&gt;
                        &lt;TR&gt;
                            &lt;TD align="center" width="3%"&gt;Òèï äîêóìåíòà&lt;/TD&gt;
							&lt;TD align="center" width="10%"&gt;Äîêóìåíò&lt;/TD&gt;
                        &lt;/TR&gt;
					&lt;/THEAD&gt;
					&lt;TBODY id="TBody"&gt;
						&lt;xsl:for-each select="Query2Table"&gt;
							&lt;TR class="GridValue"&gt;
								&lt;TD&gt;&lt;xsl:number/&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aDateReq" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aVisitor" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aVisitToWho" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aTypeDoc" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aDoc" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aVisitInit" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aOperator" /&gt;&lt;/TD&gt;
								&lt;TD align="center"&gt;&lt;xsl:value-of select="aRequestNum" /&gt;&lt;/TD&gt;
								&lt;TD align="center"&gt;&lt;xsl:value-of select="aIn" /&gt;&lt;/TD&gt;
								&lt;TD align="center"&gt;&lt;xsl:value-of select="aOut" /&gt;&lt;/TD&gt;
							&lt;/TR&gt;
						&lt;/xsl:for-each&gt;                        
					&lt;/TBODY&gt;
				&lt;/TABLE&gt;
			&lt;/BODY&gt;
		&lt;/HTML&gt;
	&lt;/xsl:template&gt;
&lt;/xsl:stylesheet&gt;
</XSLT>
      <ImageName />
      <Params>
        <Param>
          <Number>1</Number>
          <Title>Çà ïåðèîä ñ</Title>
          <Name>pDateFrom</Name>
          <Type>Date</Type>
          <Inset>false</Inset>
          <CurrentValue>01.08.2015</CurrentValue>
          <DefaultValue />
          <SelectValue />
        </Param>
        <Param>
          <Number>2</Number>
          <Title>ïî</Title>
          <Name>pDateTo</Name>
          <Type>Date</Type>
          <Inset>false</Inset>
          <CurrentValue>08.09.2015</CurrentValue>
          <DefaultValue />
          <SelectValue />
        </Param>
        <Param>
          <Number>3</Number>
          <Title>Ê êîìó</Title>
          <Name>pDep</Name>
          <Type>StrSelectTree</Type>
          <Inset>true</Inset>
          <CurrentValue>:ÂÑÅ</CurrentValue>
          <DefaultValue />
          <SelectValue>_idDep s ''
;
SELECT '', 'ÂÑÅ', 1, 'e6397305-b408-4993-8d5b-6e7f1cea6d69' 
;
SELECT
	' WHERE CAST(D1.ORG_ID AS varchar(64)) = '''+CAST(Depart.ORG_ID AS varchar(64)) +''' ',
	Depart.ORG_NAME,
	COUNT(DC.ORG_ID),
	CAST(Depart.ORG_ID AS varchar(64))

FROM	
	[Parsec3].[dbo].[ORGANIZATION] AS Depart 
	LEFT JOIN [Parsec3].[dbo].[ORGANIZATION] AS DC 
	ON Depart.ORG_ID=DC.PARENT_ID
WHERE	
	CAST(Depart.PARENT_ID AS varchar(64)) = #?_idDep?#
GROUP BY
	' D1.ORG_ID = '+CAST(Depart.ORG_ID AS varchar(64)),
	Depart.ORG_NAME,
	Depart.ORG_ID
ORDER BY 2
</SelectValue>
        </Param>
        <Param>
          <Number>4</Number>
          <Title>Èíèöèàòîð</Title>
          <Name>pInit</Name>
          <Type>StrSelectList</Type>
          <Inset>true</Inset>
          <CurrentValue>:ÂÑÅ</CurrentValue>
          <DefaultValue />
          <SelectValue>~ÂÑÅ
;
SET dateformat dmy
SELECT DISTINCT
	'WHERE BP.aVisitInitID = ''' + CAST(PP.PERS_ID as varchar(255)) + ''' ', PP.LAST_NAME
FROM
	[Parsec3].dbo.[DOMAIN_MEMBERSHIP] as DD		
		INNER JOIN [Parsec3].dbo.[IDENTIFIER] as ID ON ID.CODE = DD.CODE AND ID.PIN = DD.PIN
		INNER JOIN [Parsec3].dbo.[Person] as PP ON PP.PERS_ID = ID.PERS_ID 
WHERE
	DD.DOMAIN_ID = 'f0490f45-7aef-430e-ba89-73d2a48e869f'
ORDER BY 2
</SelectValue>
        </Param>
        <Param>
          <Number>6</Number>
          <Title>Ïîñåòèòåëü</Title>
          <Name>pPerson</Name>
          <Type>String</Type>
          <Inset>true</Inset>
          <CurrentValue />
          <DefaultValue />
          <SelectValue />
        </Param>
      </Params>
    </Query>
    <Query>
      <Code>0</Code>
      <Name>Îò÷åò î ïîñåòèòåëÿõ çà ïåðèîä (èíèöèàòîð - òåêñò)</Name>
      <DateCreate>2015-07-22T16:16:15.234375+03:00</DateCreate>
      <DateLastModified>2015-09-08T00:00:00+03:00</DateLastModified>
      <Hidden>false</Hidden>
      <Author>MaryM</Author>
      <Note />
      <Text>SET DATEFORMAT dmy

DECLARE @dtMin datetime
DECLARE @dtMax datetime
SET @dtMin = '01.01.1900'
SET @dtMax = '01.01.2100'

DECLARE @dtFrom datetime
DECLARE @dtTo datetime
SET @dtFrom = #?pDateFrom?#
SET @dtTo = #?pDateTo?#
--SET @dtFrom = '05.08.2015'
--SET @dtTo = '05.08.2015'

---Ñ÷èòûâàåì äîêóìåíò
-- Òèï äîêóìåíòà
DECLARE @DOCT TABLE(aPers uniqueidentifier, aDocType varchar(255))
INSERT INTO @DOCT	
	SELECT  VV.PERS_ID, CAST(VV.EXTRA_FIELD_VALUE as varchar(255))
	FROM
		EXTRA_FIELD_VALUE AS VV 
			INNER JOIN EXTRA_FIELD_TEMPLATE AS TT ON TT.FIELD_TEMPLATE_ID = VV.FIELD_TEMPLATE_ID 
												AND TT.FIELD_TEMPLATE_NAME = 'Òèï äîêóìåíòà'
-- Ñåðèÿ äîêóìåíòà
DECLARE @DOCS TABLE(aPers uniqueidentifier, aDocSer varchar(255))
INSERT INTO @DOCS	
	SELECT  VV.PERS_ID, CAST(VV.EXTRA_FIELD_VALUE as varchar(255))
	FROM
		EXTRA_FIELD_VALUE AS VV 
			INNER JOIN EXTRA_FIELD_TEMPLATE AS TT ON TT.FIELD_TEMPLATE_ID = VV.FIELD_TEMPLATE_ID 
												AND TT.FIELD_TEMPLATE_NAME = 'Ñåðèÿ äîêóìåíòà'					 
-- Íîìåð äîêóìåíòà
DECLARE @DOCN TABLE(aPers uniqueidentifier, aDocNumber varchar(255))
INSERT INTO @DOCN	
	SELECT  VV.PERS_ID, CAST(VV.EXTRA_FIELD_VALUE as varchar(255))
	FROM
		EXTRA_FIELD_VALUE AS VV 
			INNER JOIN EXTRA_FIELD_TEMPLATE AS TT ON TT.FIELD_TEMPLATE_ID = VV.FIELD_TEMPLATE_ID 
												AND TT.FIELD_TEMPLATE_NAME = 'Íîìåð äîêóìåíòà'	
-- Êåì âûäàí äîêóìåíò
DECLARE @DOCV TABLE(aPers uniqueidentifier, aDocMil varchar(255))												
INSERT INTO @DOCV	
	SELECT  VV.PERS_ID, CAST(VV.EXTRA_FIELD_VALUE as varchar(255))
	FROM
		EXTRA_FIELD_VALUE AS VV 
			INNER JOIN EXTRA_FIELD_TEMPLATE AS TT ON TT.FIELD_TEMPLATE_ID = VV.FIELD_TEMPLATE_ID 
												AND TT.FIELD_TEMPLATE_NAME = 'Êåì âûäàí äîêóìåíò'
-- Äàòà âûäà÷è
DECLARE @DOCD TABLE(aPers uniqueidentifier, aDocDate varchar(255))												
INSERT INTO @DOCD	
	SELECT  VV.PERS_ID, CAST(VV.EXTRA_FIELD_VALUE as varchar(255))
	FROM
		EXTRA_FIELD_VALUE AS VV 
			INNER JOIN EXTRA_FIELD_TEMPLATE AS TT ON TT.FIELD_TEMPLATE_ID = VV.FIELD_TEMPLATE_ID 
												AND TT.FIELD_TEMPLATE_NAME = 'Äàòà âûäà÷è äîêóìåíòà'	
												
-- ÇÀßÂÊÈ ÏÎÑÅÒÈÒÅËÅÉ Â ÁÞÐÎ ÏÐÎÏÓÑÊÎÂ												
DECLARE @BPVISIT TABLE
(aDateReq datetime, aVisitor varchar(255), aVisitorID uniqueidentifier, aVisitToWho varchar(255),  
aVisitInit varchar(255), aTypeDoc varchar(255), aDoc varchar(255), aOperator varchar(255), aAdmitFromDate datetime, aAdmitToDate datetime, 
aRequestNum int, aStatusReq int, aStatusReqName varchar(255), aRevisor varchar(255), aActivator varchar(255))
INSERT INTO @BPVISIT
SELECT
-- Äàòà çàêàçà
DATEADD(hour, 3, VR.REQUEST_DATE) as aDateReq, 
-- ÔÈÎ ïîñåòèòåëÿ
PV.LAST_NAME+' '+PV.FIRST_NAME+' '+PV.MIDDLE_NAME as aVisitor, 
-- ID ïîñåòèòåëÿ
VR.VISITOR_ID as aVisitorID, 
-- Ê êîìó
Dep.aDepName as aVisitToWho, 
-- Èíèöèàòîð çàÿâêè 
-- Ìîæåò ïèñàòüñÿ 
-- Â ïîëå ÊÎÌÌÅÍÒÀÐÈÉ ÐÅÂÈÇÎÐÀ
--VR.REVISOR_COMMENTS as aVisitInit,  
-- Â ïîëå Öåëü âèçèòà
--VR.VISIT_PURPOSE as aVisitInit,
-- Â ïîëå îïèñàíèå ïîñåòèòåëÿ
VR.VISITOR_INFO as aVisitInit,   
-- Äîêóìåíò
ISNULL(DT.aDocType, '') as aTypeDoc, 
ISNULL(' ' + DS.aDocSer, '') 
+ ISNULL(' ' + DN.aDocNumber, '')
+ ISNULL(' âûäàí ' + DV.aDocMil, '')  
+ ISNULL(' ' + DD.aDocDate + ' ã.', '') as aDoc, 
-- Îïåðàòîð
DMO.FULLNAME as aOperator, 
-- Äàòà íà÷àëà äåéñòâèÿ çàÿâêè
-- íà÷àëî äíÿ
CAST(CONVERT(varchar(10), VR.ADMIT_START, 104) as datetime) as aAdmitFromDate, 
--DATEADD(hour, 3, VR.ADMIT_START) as aAdmitFromDate, 
-- Äàòà îêîí÷àíèÿ äåéñòâèÿ çàÿâêè
DATEADD(hour, 3, VR.ADMIT_END) as aAdmitToDate, 
VR.REQUEST_NUM as aRequestNum, 
-- Ñòàòóñ çàÿâêè
-- 0 - Îæèäàíèå ñîãëàñîâàíèÿ
-- 1 - Ñîãëàñîâàíâ
-- 2 - Îòêëîíåíà
-- 3 - Âûäàí ïðîïóñê
-- 4 - Çàêðûòà
VR.REQUEST_STATUS as aStatusReq, 
CASE WHEN VR.REQUEST_STATUS = 0 THEN 'îæèäàíèå ñîãëàñîâàíèÿ'
		WHEN VR.REQUEST_STATUS = 1 THEN 'ñîãëàñîâàíà'
			WHEN VR.REQUEST_STATUS = 2 THEN 'îòêëîíåíà'
				WHEN VR.REQUEST_STATUS = 3 THEN 'âûäàí ïðîïóñê'
					WHEN VR.REQUEST_STATUS = 4 THEN 'çàêðûòà'
ELSE '' END as aStatusReqName, 
-- Ðåâèçîð çàÿâêè
DMR.FULLNAME as aRevisor, 
-- Àêòèâàòîð çàÿâêè
DMA.FULLNAME as aActivator


FROM 
[Parsec3].dbo.[VISITOR_REQUEST] as VR
	LEFT JOIN [Parsec3].dbo.[PERSON] as PV ON VR.VISITOR_ID = PV.PERS_ID
	LEFT JOIN [Parsec3].dbo.[DOMAIN_MEMBERSHIP] as DMR ON VR.REVISOR_ID = DMR.M_ID
	LEFT JOIN [Parsec3].dbo.[DOMAIN_MEMBERSHIP] as DMO ON VR.OPERATOR_ID = DMO.M_ID
	LEFT JOIN [Parsec3].dbo.[DOMAIN_MEMBERSHIP] as DMA ON VR.ACTIVATOR_ID = DMA.M_ID
	LEFT JOIN @DOCT as DT ON DT.aPers = VR.VISITOR_ID
	LEFT JOIN @DOCS as DS ON DS.aPers = VR.VISITOR_ID
	LEFT JOIN @DOCN as DN ON DN.aPers = VR.VISITOR_ID
	LEFT JOIN @DOCV as DV ON DV.aPers = VR.VISITOR_ID 
	LEFT JOIN @DOCD as DD ON DD.aPers = VR.VISITOR_ID 
	INNER JOIN
			(
			SELECT D1.ORG_ID AS DD, D1.ORG_NAME as aDepName 
				FROM [Parsec3].[dbo].[ORGANIZATION] AS D1 
					#?pDep?#
			UNION
			SELECT D2.ORG_ID AS DD, D2.ORG_NAME as aDepName 
				FROM [Parsec3].[dbo].[ORGANIZATION] AS D1 
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D2 ON D1.ORG_ID=D2.PARENT_ID
					#?pDep?#
			UNION
			SELECT D3.ORG_ID AS DD, D3.ORG_NAME as aDepName
				FROM [Parsec3].[dbo].[ORGANIZATION] AS D1 
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D2 ON D1.ORG_ID=D2.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D3 ON D2.ORG_ID=D3.PARENT_ID
					#?pDep?#
			UNION
			SELECT D4.ORG_ID AS DD, D4.ORG_NAME as aDepName 
				FROM [Parsec3].[dbo].[ORGANIZATION] AS D1 
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D2 ON D1.ORG_ID=D2.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D3 ON D2.ORG_ID=D3.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D4 ON D3.ORG_ID=D4.PARENT_ID
					#?pDep?#
			UNION
			SELECT D5.ORG_ID AS DD, D5.ORG_NAME as aDepName 
				FROM [Parsec3].[dbo].[ORGANIZATION] AS D1 
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D2 ON D1.ORG_ID=D2.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D3 ON D2.ORG_ID=D3.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D4 ON D3.ORG_ID=D4.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D5 ON D4.ORG_ID=D5.PARENT_ID
					#?pDep?#
			UNION
			SELECT D6.ORG_ID AS DD, D6.ORG_NAME as aDepName 
				FROM [Parsec3].[dbo].[ORGANIZATION] AS D1 
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D2 ON D1.ORG_ID=D2.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D3 ON D2.ORG_ID=D3.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D4 ON D3.ORG_ID=D4.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D5 ON D4.ORG_ID=D5.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D6 ON D5.ORG_ID=D6.PARENT_ID
					#?pDep?#
			UNION
			SELECT D7.ORG_ID AS DD, D7.ORG_NAME as aDepName 
				FROM [Parsec3].[dbo].[ORGANIZATION] AS D1 
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D2 ON D1.ORG_ID=D2.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D3 ON D2.ORG_ID=D3.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D4 ON D3.ORG_ID=D4.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D5 ON D4.ORG_ID=D5.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D6 ON D5.ORG_ID=D6.PARENT_ID
					INNER JOIN [Parsec3].[dbo].[ORGANIZATION] AS D7 ON D6.ORG_ID=D7.PARENT_ID
					#?pDep?#
		) AS DEP ON VR.OWNER_ID = DEP.DD
WHERE
@dtFrom &lt;= CAST(CONVERT(varchar(10), DATEADD(hour, 3, VR.ADMIT_END), 104) as datetime) AND
@dtTo &gt;= CAST(CONVERT(varchar(10), DATEADD(hour, 3, VR.ADMIT_START), 104) as datetime) AND
ISNULL(VR.VISITOR_INFO, '') LIKE '%#?pInit?#%' AND 
ISNULL(PV.LAST_NAME+' '+PV.FIRST_NAME+' '+PV.MIDDLE_NAME, '') LIKE '%#?pPerson?#%'


--1
--SELECT * FROM @BPVISIT ORDER BY aDateReq, aVisitor

-- ÏÐÎÕÎÄÛ (ÒÐÀÍÇÀÊÖÈÈ) ñ òèïîì ÍÎÐÌÀËÜÍÛÉ ÂÕÎÄ ÏÎ ÊËÞ×Ó è ÍÎÐÌÀËÜÍÛÉ ÂÛÕÎÄ ÏÎ ÊËÞ×Ó
DECLARE @TINOUT TABLE(aID int, aMask int, 
					aTranTypeID int, 
					aTranDescription varchar(255), 
					aPersID uniqueidentifier, 
					aTranDate datetime,  
					aComp varchar(255))
INSERT INTO @TINOUT						
SELECT
PTTL.rid as aID, 
PTT.TRANCLASS_MASK as aMask, 
PTTL.TRANTYPE_ID as aTranTypeID, 
PTD.TRANTYPE_DESC as aTranDescription, 
PTTL.USR_ID as aPersID, 
DATEADD(hour, 3, PTTL.TRAN_DATE) as aTranDate, 
PTER.TERRA_NAME as aComp
FROM 
	[Parsec3Trans].dbo.[TransLog] AS PTTL
		INNER JOIN [Parsec3].[dbo].[TRANTYPES_DESC] AS PTD 
			ON PTTL.TRANTYPE_ID = PTD.TRANTYPE_ID
			AND PTD.LOCALE = 'RU'
		INNER JOIN [Parsec3].[dbo].[TRANTYPES] AS PTT
			ON PTTL.TRANTYPE_ID = PTT.TRANTYPE_ID
		INNER JOIN [Parsec3].[dbo].[TERRITORY] AS PTER
			ON PTTL.COMP_ID = PTER.ITEM_ID

WHERE
	DATEADD(hour, 3, PTTL.TRAN_DATE) &gt;= @dtFrom
	AND DATEADD(hour, 3, PTTL.TRAN_DATE) &lt; DATEADD(day, 1, @dtTo)
	AND PTTL.TRANTYPE_ID IN(590144, 590145)					

--2
--SELECT * FROM @TINOUT ORDER BY 5 DESC

-- Ðàñøíóðóåì òàáëè÷êó ïðîõîäîâ íà âõîäû è âûõîäû
DECLARE @TINOUT2 TABLE(
					aID int, 
					aPersID uniqueidentifier, 
					aTranDateIn datetime,  
					aTranDateOut datetime
					)
INSERT INTO @TINOUT2						
SELECT
TT.aID as aID, 
TT.aPersID as aPersID, 
CASE WHEN TT.aTranTypeID = 590144 THEN TT.aTranDate
		ELSE NULL--@dtMin
			END as aTranDateIn, 
CASE WHEN TT.aTranTypeID = 590145 THEN TT.aTranDate
		ELSE NULL --@dtMax
			END as aTranDateOut
FROM 
	@TINOUT as TT
ORDER BY 1, 2, 3

--3
--SELECT * FROM @TINOUT2 ORDER BY 1, 2, 3

-- Ñãðóïïèðóåì ïî ïåðñîíå è äàòå	
DECLARE @TINOUT3 TABLE(aPersID uniqueidentifier, aDateIn datetime, aDateOut datetime)
INSERT INTO @TINOUT3
SELECT 
TT1.aPersID, 
ISNULL(MIN(TT1.aTranDateIn), @dtMin), 
ISNULL(MAX(TT2.aTranDateOut), @dtMax)
FROM 
@TINOUT2 as TT1
LEFT JOIN @TINOUT2 as TT2 ON TT1.aPersID = TT2.aPersID
							--and CONVERT(varchar(10), TT1.aTranDateIn, 104) = CONVERT(varchar(10), TT2.aTranDateOut, 104)
							and TT1.aTranDateIn &lt; TT2.aTranDateOut 
													
WHERE 
NOT (TT1.aTranDateIn IS NULL AND TT2.aTranDateOut IS NULL)
GROUP BY 
TT1.aPersID

ORDER BY 1 DESC

--4
--SELECT * FROM @TINOUT3

--ÂÛÕÎÄÍÀß ÒÀÁËÈÖÀ
SELECT
CONVERT(varchar(10), BP.aDateReq, 104) + ' ' + CAST(DATEPART(hour, BP.aDateReq) as varchar(2)) + ':' 
				+ CASE 
					WHEN LEN(CAST(DATEPART(minute, BP.aDateReq) as varchar(2))) = 1 
						THEN '0' + CAST(DATEPART(minute, BP.aDateReq) as varchar(2))
					ELSE CAST(DATEPART(minute, BP.aDateReq) as varchar(2))
					END 
				+ ':' 
				+ CASE
					WHEN LEN(CAST(DATEPART(ss, BP.aDateReq) as varchar(2))) = 1
						THEN '0' + CAST(DATEPART(ss, BP.aDateReq) as varchar(2))
					ELSE CAST(DATEPART(ss, BP.aDateReq) as varchar(2))
					END 
				as aDateReq, 
TT.aPersID as aVisitorID, 
BP.aVisitor as aVisitor,
CASE WHEN TT.aDateIn = @dtMin THEN '' 
		ELSE
			CONVERT(varchar(10), TT.aDateIn, 104) + ' ' + CAST(DATEPART(hour, TT.aDateIn) as varchar(2)) + ':' 
				+ CASE 
					WHEN LEN(CAST(DATEPART(minute, TT.aDateIn) as varchar(2))) = 1 
						THEN '0' + CAST(DATEPART(minute, TT.aDateIn) as varchar(2))
					ELSE CAST(DATEPART(minute, TT.aDateIn) as varchar(2))
					END 
				+ ':' 
				+ CASE 
					WHEN LEN(CAST(DATEPART(ss, TT.aDateIn) as varchar(2))) = 1
						THEN '0' + CAST(DATEPART(ss, TT.aDateIn) as varchar(2))
					ELSE CAST(DATEPART(ss, TT.aDateIn) as varchar(2))
					END
		END as aIn, 
CASE WHEN TT.aDateOut = @dtMax THEN ''
		ELSE 
			CONVERT(varchar(10), TT.aDateOut, 104) + ' ' + CAST(DATEPART(hour, TT.aDateOut) as varchar(2)) + ':' 
				+ CASE 
					WHEN LEN(CAST(DATEPART(minute, TT.aDateOut) as varchar(2))) = 1 
						THEN '0' + CAST(DATEPART(minute, TT.aDateOut) as varchar(2))
					ELSE CAST(DATEPART(minute, TT.aDateOut) as varchar(2))
					END 
				+ ':' 
				+ CASE 
					WHEN LEN(CAST(DATEPART(ss, TT.aDateOut) as varchar(2))) = 1
						THEN '0' + CAST(DATEPART(ss, TT.aDateOut) as varchar(2))
					ELSE CAST(DATEPART(ss, TT.aDateOut) as varchar(2))
					END
		END as aOut, 
BP.aVisitToWho as aVisitToWho, 
BP.aOperator as aOperator, 
BP.aRequestNum as aRequestNum, 
BP.aVisitInit as aVisitInit, 
BP.aTypeDoc as aTypeDoc, 
BP.aDoc as aDoc

FROM
@TINOUT3 as TT
		INNER JOIN @BPVISIT AS BP ON TT.aPersID = BP.aVisitorID 
			-- îãðàíè÷åíèÿ ïî íà÷àëó è îêîí÷àíèþ äîñòóïà èç òàáëèöû ïî ïîñåòèòåëÿì
		AND TT.aDateIn &lt;= BP.aAdmitToDate AND TT.aDateOut &gt;= BP.aAdmitFromDate

ORDER BY TT.aDateIn	


-- Âûõîäíàÿ òàáëèöà 2 Ê ÊÎÌÓ
SELECT TOP 1
	D1.ORG_NAME AS aDepName	
FROM
	(
		SELECT NEWID() AS ORG_ID, ' Â Ñ Å' AS ORG_NAME
		UNION ALL
		SELECT DD.ORG_ID AS ORG_ID, DD.ORG_NAME AS ORG_NAME
		FROM [Parsec3].[dbo].[ORGANIZATION] AS DD
		WHERE LEN(DD.ORG_NAME) &gt; 0
	) AS D1
#?pDep?#

		


</Text>
      <XSLT>&lt;?xml version="1.0" encoding="Windows-1251" ?&gt;
&lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
&lt;xsl:output method="xml" version="1.0" encoding="windows-1251" indent="yes"/&gt;
	&lt;xsl:template match="/Query2DS"&gt;
		&lt;HTML&gt;
			&lt;STYLE TYPE="text/css"&gt;
				.Caption{font-weight: bold; font-size: 16pt; text-align: center; color: #800040}
				.Param{font-weight: bold; font-size: 14pt; color: black}
			&lt;/STYLE&gt;
			
			&lt;HEAD&gt;
				&lt;TITLE&gt;Îò÷åò î ïîñåòèòåëÿõ çà ïåðèîä&lt;/TITLE&gt;
			&lt;/HEAD&gt;         
            
			&lt;BODY bgcolor="#FFFFFF"&gt;
				&lt;P class="Caption"&gt;
					Îò÷åò î ïîñåòèòåëÿõ îáúåêòà çà ïåðèîä 
					ñ #?pDateFrom?#ã. ïî #?pDateTo?#ã.
					&lt;TABLE width="50%"&gt;
					&lt;TR class="Param"&gt;&lt;TD align="left" width="20%"&gt;Ê êîìó:&lt;/TD&gt;&lt;TD align="left" width="80%"&gt;&lt;xsl:value-of select="Query2Table2/aDepName" /&gt;&lt;/TD&gt;&lt;/TR&gt;
					&lt;TR class="Param"&gt;&lt;TD align="left" width="20%"&gt;Èíèöèàòîð:&lt;/TD&gt;&lt;TD align="left" width="80%"&gt; #?pInit?# &lt;/TD&gt;&lt;/TR&gt;
					&lt;TR class="Param"&gt;&lt;TD align="left" width="20%"&gt;Ïîñåòèòåëü:&lt;/TD&gt;&lt;TD align="left" width="80%"&gt; #?pPerson?# &lt;/TD&gt;&lt;/TR&gt;
					&lt;/TABLE&gt;
				&lt;/P&gt;
				
				&lt;TABLE width="100%" border="1" ID="GridTable" onclick="sortColumn(event)"&gt;
					&lt;!-- ÷òîáû øàïêà òàáëèöû ïîÿâëÿëàñü íà êàæäîé ñòðàíèöå ïðè ïå÷àòè --&gt;
					&lt;THEAD class="GridCaption"&gt;                     
						&lt;TR&gt;
							&lt;TD align="center" rowspan="2" width="3%"&gt;¹ ï/ï&lt;/TD&gt;
							&lt;TD align="center" rowspan="2" width="5%"&gt;Äàòà çàÿâêè&lt;/TD&gt;
							&lt;TD align="center" rowspan="2" width="15%"&gt;Ô.È.Î ïîñåòèòåëÿ&lt;/TD&gt;
							&lt;TD align="center" rowspan="2" width="3%"&gt;Ê êîìó&lt;/TD&gt;
                            &lt;TD align="center" colspan="2" width="10%"&gt;Ïðåäúÿâëåííûé äîêóìåíò&lt;/TD&gt;
							&lt;TD align="center" rowspan="2" width="10%"&gt;Èíèöèàòîð çàÿâêè&lt;/TD&gt;
							&lt;TD align="center" rowspan="2" width="10%"&gt;Çàÿâêó ââåë&lt;/TD&gt;
							&lt;TD align="center" rowspan="2" width="3%"&gt;Âûäàí ïðîïóñê ¹&lt;/TD&gt;
							&lt;TD align="center" rowspan="2" width="3%"&gt;Âðåìÿ âõ.&lt;/TD&gt;
							&lt;TD align="center" rowspan="2" width="3%"&gt;Âðåìÿ âûõ.&lt;/TD&gt;
						&lt;/TR&gt;
                        &lt;TR&gt;
                            &lt;TD align="center" width="3%"&gt;Òèï äîêóìåíòà&lt;/TD&gt;
							&lt;TD align="center" width="10%"&gt;Äîêóìåíò&lt;/TD&gt;
                        &lt;/TR&gt;
					&lt;/THEAD&gt;
					&lt;TBODY id="TBody"&gt;
						&lt;xsl:for-each select="Query2Table"&gt;
							&lt;TR class="GridValue"&gt;
								&lt;TD&gt;&lt;xsl:number/&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aDateReq" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aVisitor" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aVisitToWho" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aTypeDoc" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aDoc" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aVisitInit" /&gt;&lt;/TD&gt;
								&lt;TD&gt;&lt;xsl:value-of select="aOperator" /&gt;&lt;/TD&gt;
								&lt;TD align="center"&gt;&lt;xsl:value-of select="aRequestNum" /&gt;&lt;/TD&gt;
								&lt;TD align="center"&gt;&lt;xsl:value-of select="aIn" /&gt;&lt;/TD&gt;
								&lt;TD align="center"&gt;&lt;xsl:value-of select="aOut" /&gt;&lt;/TD&gt;
							&lt;/TR&gt;
						&lt;/xsl:for-each&gt;                        
					&lt;/TBODY&gt;
				&lt;/TABLE&gt;
			&lt;/BODY&gt;
		&lt;/HTML&gt;
	&lt;/xsl:template&gt;
&lt;/xsl:stylesheet&gt;
</XSLT>
      <ImageName />
      <Params>
        <Param>
          <Number>1</Number>
          <Title>Çà ïåðèîä ñ</Title>
          <Name>pDateFrom</Name>
          <Type>Date</Type>
          <Inset>false</Inset>
          <CurrentValue>01.08.2015</CurrentValue>
          <DefaultValue />
          <SelectValue />
        </Param>
        <Param>
          <Number>2</Number>
          <Title>ïî</Title>
          <Name>pDateTo</Name>
          <Type>Date</Type>
          <Inset>false</Inset>
          <CurrentValue>08.09.2015</CurrentValue>
          <DefaultValue />
          <SelectValue />
        </Param>
        <Param>
          <Number>3</Number>
          <Title>Ê êîìó</Title>
          <Name>pDep</Name>
          <Type>StrSelectTree</Type>
          <Inset>true</Inset>
          <CurrentValue>:ÂÑÅ</CurrentValue>
          <DefaultValue />
          <SelectValue>_idDep s ''
;
SELECT '', 'ÂÑÅ', 1, 'e6397305-b408-4993-8d5b-6e7f1cea6d69' 
;
SELECT
	' WHERE CAST(D1.ORG_ID AS varchar(64)) = '''+CAST(Depart.ORG_ID AS varchar(64)) +''' ',
	Depart.ORG_NAME,
	COUNT(DC.ORG_ID),
	CAST(Depart.ORG_ID AS varchar(64))

FROM	
	[Parsec3].[dbo].[ORGANIZATION] AS Depart 
	LEFT JOIN [Parsec3].[dbo].[ORGANIZATION] AS DC 
	ON Depart.ORG_ID=DC.PARENT_ID
WHERE	
	CAST(Depart.PARENT_ID AS varchar(64)) = #?_idDep?#
GROUP BY
	' D1.ORG_ID = '+CAST(Depart.ORG_ID AS varchar(64)),
	Depart.ORG_NAME,
	Depart.ORG_ID
ORDER BY 2
</SelectValue>
        </Param>
        <Param>
          <Number>4</Number>
          <Title>Èíèöèàòîð</Title>
          <Name>pInit</Name>
          <Type>String</Type>
          <Inset>true</Inset>
          <CurrentValue>æåíà</CurrentValue>
          <DefaultValue />
          <SelectValue>
</SelectValue>
        </Param>
        <Param>
          <Number>6</Number>
          <Title>Ïîñåòèòåëü</Title>
          <Name>pPerson</Name>
          <Type>String</Type>
          <Inset>true</Inset>
          <CurrentValue />
          <DefaultValue />
          <SelectValue />
        </Param>
      </Params>
    </Query>
  </Queries>
</Session>